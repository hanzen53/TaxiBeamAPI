<!DOCTYPE>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/assets/css/taxiadmin-style.css" />
	<link rel="stylesheet" type="text/css" href="/assets/css/font/style.css" />
	<link rel="stylesheet" type="text/css" href="/assets/css/bootstrap-datepicker.standalone.css" />
	<link rel="stylesheet" type="text/css" href="/assets/css/iconfont/style.css" />
	<link rel="stylesheet" type="text/css" href="/assets/css/taxiadmin-responsive.css" />
	<link rel="stylesheet" type="text/css" href="/assets/css/EC.Popup.css">
	<link rel="stylesheet" href="/assets/css/app.css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">

	<script type="text/javascript" src="/assets/libs/js/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="/assets/libs/js/taxiadmin-function.js"></script>
	<script type="text/javascript" src="/assets/libs/js/bootstrap-datepicker.js"></script>
	<script src="/assets/libs/js/modernizr.custom.js"></script>
	<script type="text/javascript" src="/assets/libs/js/placeholder.js"></script>
	<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/taxiadmin-ie8.css"><![endif]-->
	<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/taxiadmin-ie9.css"><![endif]-->
	<!--[if IE]><!-->
	<style type="text/css">

	</style><!--<![endif]-->
	
	<script src="/assets/libs/jquery-ui/jquery.ui.touch-punch.min.js"></script>	
	<script src="/assets/libs/angular/angular.js"></script>	
	<script src="/assets/libs/jquery/dist/jquery.min.js"></script>	
	<!--script src="http://hmap.ecartmap.com/v1/hobbit-loader.js"></script-->

	<script src="https://nhmap.ecartmap.com/v1_2/?key=Evs0z2OaYLDO8e3sl8HwK7MwiS66Y@7Yqo-K$eeRwRQkxqrbO$"></script>
	<!--script src="https://nhmap.ecartmap.com/v1_2/?key=NM7SZ26ZV$jN6Ed8-TJ2@dx4cXXOuj9H9rrD5OOgU4Fh4hSavu"></script -->

	<script src="http://rawgithub.com/openplans/Leaflet.AnimatedMarker/master/src/AnimatedMarker.js"></script>
	<script src="http://rawgithub.com/makinacorpus/Leaflet.GeometryUtil/master/dist/leaflet.geometryutil.js"></script>
	<!-- Start Auto complete -->
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
	<!-- End Auto complete --> 
	<!-- EC.Popup -->
	<script src="/assets/libs/js/EC.Popup.js"></script>



<style>
.color.taxiadmin-input-form i , .year.taxiadmin-input-form i {
	display: none;
}

input {
	font-family: 'Tahoma';
}

*{
	font-family: verdana;
	font-size: 12px;
}

input[type='button']{
	background: #5B8EEE;
	width: 90px;
	height: 30px;
	border: 1px solid #CBDBFA;
	color: white;
	font-weight: bold;
	margin: 0 auto;
	display: block;
}


/*-- start main table --*/
.table-list-div {
	overflow-y:scroll;
	position: absolute;
	width: 100%;
	height: 250px;
}
.table-list{
	font-family: verdana;
	font-size: 12px;
	border: 1px solid #EAEAEA;
	padding: 5px;
	background: #ffffff;
	margin: 0 auto;
	max-height: 200px;
	overflow: auto;

}
.table-list th{
	background: #EDF2F6;
	border-bottom: 1px dotted #DDDDDD;
	color: #444444;
	font-size: 12px;
	font-weight: normal !important;
	height: 28px;
	line-height: 28px;
	padding-left: 5px;
	text-align: left;
}
.table-list td{
	border-bottom: 1px dotted #EAEAEA;
	font-family: Arial,Helvetica,sans-serif;
	font-size: 12px;
	height: 28px;
	padding: 5px;
	text-align: left;
}
.table-list tr:hover{
	background: #E3F3F9;
}
/* --- end main table ---*/



/*-- start status ON table --*/
.table-list-on-div {
	overflow-y:scroll;
	position: relative;
	width: 100%;
	height: 250px;
	display: block;
	padding: 0px;
}
.table-list-on{
	font-family: verdana;
	font-size: 12px;
	border: 1px solid #EAEAEA;
	padding: 5px;
	background: #ffffff;
	margin: 0 auto;
	max-height: 200px;
	overflow: auto;

}
.table-list-on th{
	background: #EDF2F6;
	border-bottom: 1px dotted #DDDDDD;
	color: #444444;
	font-size: 12px;
	font-weight: normal !important;
	height: 28px;
	line-height: 28px;
	padding-left: 5px;
	text-align: left;
}
.table-list-on td{
	border-bottom: 1px dotted #EAEAEA;
	font-family: Arial,Helvetica,sans-serif;
	font-size: 12px;
	height: 28px;
	padding: 5px;
	text-align: left;
}
.table-list-on tr:hover{
	background: #E3F3F9;
}
/* --- end ON table ---*/




/*-- start status MANUAL table --*/
.table-list-manual-div {
	overflow-y:scroll;
	position: relative;
	width: 100%;
	height: 250px;
	display: block;
}
.table-list-manual{
	font-family: verdana;
	font-size: 12px;
	border: 1px solid #EAEAEA;
	padding: 5px;
	background: #ffffff;
	margin: 0 auto;
	max-height: 200px;
	overflow: auto;

}
.table-list-manual th{
	background: #CFCFCF;
	border-bottom: 1px dotted #DDDDDD;
	color: #444444;
	font-size: 12px;
	font-weight: normal !important;
	height: 28px;
	line-height: 28px;
	padding-left: 5px;
	text-align: left;
}
.table-list-manual td{
	border-bottom: 1px dotted #EAEAEA;
	font-family: Arial,Helvetica,sans-serif;
	font-size: 12px;
	height: 28px;
	padding: 5px;
	text-align: left;
}
.table-list-manual tr:hover{
	background: #E3F3F9;
}
/* --- end ON table ---*/















.entry-form{
	background: #EDF2F6;
	width: 350px;
	padding: 10px;
	border: 5px solid #C5D7E2;
	box-shadow: 3px 3px 5px #888;
	position: absolute;
	top: 25%;
	left: 35%;
	display: none;
	border-radius: 5px;
	z-index: 15;
}

.entry-form input[type='text']{
	border: 1px solid #BBBBBB;
	box-shadow: 2px 2px 4px #C5D7E2 inset;
	height: 25px;
	width: 200px;
}

.entry-form input[type='text']:focus{
	border: 1px solid #C5D7E2;
}

#idirection {  
	width: 400px; 
	height: 200px; 
	background-color: #ccc; 
	padding: 10px; 
	line-height: 25px; 
	position: absolute; 
	top: 10px; 
	left: 350px; 
	z-index: 11; 
}

/* start css for autocomplete  : http://www.pontikis.net/blog/jquery-ui-autocomplete-step-by-step */
/* highlight results */
.ui-autocomplete span.hl_results {
 	background-color: #ffff66;
}

/* loading - the AJAX indicator */
.ui-autocomplete-loading {
 	background: white url('../img/ui-anim_basic_16x16.gif') right center no-repeat;
}

/* scroll results */
.ui-autocomplete {
	max-height: 250px;
	overflow-y: auto;
	/* prevent horizontal scrollbar */
	overflow-x: hidden;
	/* add padding for vertical scrollbar */
	padding-right: 5px;
}

.ui-autocomplete li {
	font-size: 16px;
}
   
  /* IE 6 doesn't support max-height
  * we use height instead, but this forces the menu to always be this tall
  */
  * html .ui-autocomplete {
      	height: 250px;
  }
  /* start css for autocomplete */

.map-box {  
  	width: 100%; 
  	height: 100%; 
  	float: left;
}

.myVar_true{ 
	color:#000; 
	background-color: #ccc;
}

/*.myVar_false{ color:green; background-color: green; }*/
.ui-buttom{
	font-size:10px;
}

.fill-input{
	font-size:10px;
	border:0.1em solid #C2CFDF;
}

div.head{
	font-size: 14px;
	font-weight: bold;
	background-color:#FFCC66;
}

.text{
	padding: 5px 10px 0px 0px;	
	font-size : 12px;
	font-weight: bold;
}

div.table{
	width: 250px;
	border:0.01em solid #FFCC66;
	padding: 2px 5px 10px 5px;
	
}

.text-data{
	font-size : 12px;
	padding: 5px 10px 0px 5px;	
}

.ui-buttom{
	font-size:10px;
}

label{
	cursor:pointer;
}

.ui-exam{
	font-size:9px;
	color:gray;	
} 

.ui-dialog{
	font-size:12px;
}

.ui-datepicker{  
	font-size:10px;  
}



</style>

		
</head>

<body>
	<div class="taxiadmin-container">
		<div class="taxiadmin-header">
			<div class="taxiadmin-header-menu">
				<a class="garageadmin-homelogo" href="#"><img src="/assets/img/taxiadmin-logo.png" srcset="/assets/img/taxiadmin-logo@2x.png 2x"></a>
			</div>

			<div class="taxiadmin-search">
				<a href="" class="garageadmin-btn-search"><i class="icon-ico_search"></i></a>
				<div class="taxiadmin-groupsearch last">					
					<input type="text" placeholder="ชื่อ, สกุล, ทะเบียนรถ, รหัสแท็กซี่" name="drivernearby" id="drivernearby" value=""  class="ui-autocomplete-input ui-corner-all" autocomplete="off">
					<div class="taxiadmin-border-search"></div>
				</div>
				<div class="taxiadmin-groupsearch">
					<input type="text" placeholder="ค้นหาสถานที่" name="placenearby" id="placenearby" value=""  class="ui-autocomplete-input ui-corner-all" autocomplete="off">
					<div class="taxiadmin-border-search"></div>
				</div>
				<div class="taxiadmin-groupsearch last">
					<table >
						<tr>
							<td width=75><a href="#" OnClick="getTaxibemList('OFF')";><img src="../assets/img/map/pin-taxi-off-label.png" align="middle"></a></td>
							<td width=75><a href="#" OnClick="getTaxibemList('ON')";><img src="../assets/img/map/pin-taxi-on-label.png" align="middle"></a></td>
							<td width=75><a href="#" OnClick="getTaxibemList('WAIT')";><img src="../assets/img/map/pin-taxi-wait-label.png" align="middle"></a></td>
							<td width=75><a href="#" OnClick="getTaxibemList('BUSY')";><img src="../assets/img/map/pin-taxi-busy-label.png" align="middle"></a></td>
							<td width=65><a href="#" OnClick="getTaxibemList('PICK')";><img src="../assets/img/map/pin-taxi-pick-label.png" align="middle"></a></td>
						</tr>
					</table>
				</div>

				
			</div>
			<div class="taxiadmin-user">
				<ul>
					<li>
						<a>Monitor</a>
						<div class="taxiadmin-user-picture">
							<img src="/assets/img/map/pin-taxi.png">
						</div>
						<!--ul class="taxiadmin-user-option">
							<li class="taxiadmin-change-password-btn"><a>เปลี่ยนรหัสผ่าน</a></li>
							<li><a href="taxiadmin-login.html">ออกจากระบบ</a></li>
						</ul-->
					</li>
				</ul>
			</div>
		</div>
		<div class="taxiadmin-navigation-menu active">
			<!--ul>
				<li><a class="taxiadmin-ico-menu"><i class="icon-menu_show"></i></a></li>
				<li class="active"><a href="taxiadmin-home.html"><i class="icon-menu"></i><p>หน้าแรก</p></a></li>
				<li><a href="taxiadmin-driver-list.html"><i class="icon-menu_chf"></i><p>ข้อมูลคนขับ</p></a></li>
				<li><a href="taxiadmin-taxi-list.html"><i class="icon-menu_taxi"></i><p>ข้อมูลรถแท๊กซี่</p></a></li>
				<li><a href="taxiadmin-message.html"><i class="icon-menu_msg"></i><p>ส่งข้อความ</p></a></li>
				<li><a href="taxiadmin-stat.html"><i class="icon-menu_stat"></i><p>สถิติ</p></a></li>
				<li><a href="taxiadmin-setting.html"><i class="icon-menu_setting"></i><p>ปรับแต่ง</p></a></li>
			</ul-->
			<ul>
				<li><a class="taxiadmin-ico-menu active"><i class="icon-menu_show"></i></a></li>
				<li><input  id="add_new" type="button" value="ใส่งาน"  ></li>
				<!--li class="active"><a href="./"><i class="icon-menu"></i><p>หน้าแรก</p></a></li-->
				<li>
					<!--a href="#"><i class="icon-menu_chf"></i><p>ON</p></a-->					
					<div class="table-list-on-div">					
					<table class="table-list-on" width="95%" cellspacing="0" cellpadding="0" border="0">
						<tbody>
						<tr>							
							<th colspan="5">[ status ON ]</th>							
						</tr>
						<tr>							
							<th width="15%">เวลา</th>
							<th width="25%">โทรศัพท์</th>
							<th width="20%">จุดรับ</th>
							<th width="20%">จุดส่ง</th>
							<th width="10%">xxx</th>
						</tr>
						</tbody>
					</table>
					</div>
				</li>
				
				<!--li class="active"><a href="./"><i class="icon-menu"></i><p>หน้าแรก</p></a></li-->
				<li>
					<!--a href="#"><i class="icon-menu_chf"></i><p>MANUAL</p></a-->
					<div class="table-list-manual-div">					
					<table class="table-list-manual" width="95%" cellspacing="0" cellpadding="0" border="0">
						<tbody>
						<tr>							
							<th colspan="5">[ status MANUAL ]</th>							
						</tr>
						<tr>							
							<th width="15%">เวลา</th>
							<th width="25%">โทรศัพท์</th>
							<th width="20%">จุดรับ</th>
							<th width="20%">จุดส่ง</th>
							<th width="10%">xxx</th>
						</tr>
						</tbody>
					</table>
					</div>
				</li>				
			</ul>	

		</div>

		<div class="entry-form">
			<form name="userinfo" id="userinfo"> 
			<table width="100%" border="0" cellpadding="4" cellspacing="0">
				<tr>
					<td colspan="2" align="right"><a href="#" id="close">Close</a></td>
				</tr>
				<tr>
					<td>จุดรับ</td>					
					<td><input type="text" placeholder="" name="curaddr" id="curaddr" value=""  class="ui-autocomplete-input ui-corner-all" autocomplete="off"></td>				
				</tr>
				<tr>
					<td>จุดส่ง</td>
					<td><input type="text" name="destination" id="destination"></td>
				</tr>
				<tr>
					<td>โทรศัพท์</td>
					<td><input type="text" name="phone" id="phone"></td>
				</tr>
				<tr>
					<td align="right"></td>
					<td><input type="button" value="Save" id="save"><!--input type="button" value="cancel" id="cancel"--></td>
				</tr>
			</table>
			</form>
		</div>

		<div class="taxiadmin-content home active">
			<div class="taxiadmin-content-wrapper">
				<div class="taxiadmin-inspica-search">
					<ul>
						<li>พระราม 9</li>
						<li>อาคารควาวาซากิ ถนนพระราม 9 กรุงเทพฯ</li>
						<li>โรงพยาบาลพระราม 9 ถนนพระราม9 ซอย 50 กรุงเทพฯ</li>
						<li>แยก อสมท พระราม 9 กรุงเทพฯ</li>
						<li>อาคารว่องวานิ112/14 ถนนพระราม 9 กรุงเทพฯ</li>
					</ul>
				</div>
				<div class="taxiadmin-taxi-status">
					<ul>
						<li><p>สถานะรถแท็กซี่<i class="icon-ico_sortup"></i></p>
							<ul class="taxiadmin-hidden-status">
								<li><div class="taxiadmin-status-avaliable"></div><p>รถว่าง</p></li>
								<li><div class="taxiadmin-status-unavaliable"></div><p>มีผู้โดยสาร</p></li>
								<li><div class="taxiadmin-status-broken"></div><p>รถเสีย</p></li>
							</ul>
						</li>
					</ul>
				</div>


				<a class="taxiadmin-search-map">Search this Area</a>
				<!--img class="taxiadmin-map" src="/assets/img/taxiadmin-map.jpg"-->
				<!-- map -->
				<div id="map" style="min-height:100%;"></div>   				
			</div>
		</div>
		<div class="taxiadmin-footer">©2014 Ecartstudio Co.,Ltd. All Reserved</div>
		<div class="taxiadmin-change-password-overlay"></div>
		<div class="taxiadmin-change-password">
			<div class="taxiadmin-change-password-title">
				เปลี่ยนรหัสผ่าน
			</div>
			<div class="taxiadmin-close-dialog">
				<i class="icon-ico_close"></i>
			</div>
			<div class="taxiadmin-change-password-form">
				<p>รหัสเดิม</p>
				<input type="password">
				<p>รหัสใหม่</p>
				<input type="password">
				<p>ยืนยันรหัสใหม่</p>
				<input type="password">
				<input type="submit" value="เปลี่ยนรหัส" class="taxiadmin-btn-changepw">
			</div>
		</div>
	</div>

<div id="zz" title="Driver dialog">
  <p>Driver information</p>
</div>


<div id="dialogsearchnamecar" title="ทดสอบ">  
</div>

</body>






  <script>

  $( "#popup-infoa" ).draggable();
  
  //var socket = io.connect('http://localhost:1115');
  //var socket = io.connect(document.location.hostname+':1115');
  	
  var  tempid = 0;
  var map = H.map("map");
  var drawControl = new L.Control.Draw();

  var marker;
  var nLayer;
  var kml;
  var fires24;
  var toggleState = true;
  var jsonPoiList = 0;

  var CStartingP;
  var CEndingP;
  var CStartingPlat;
  var CStartingPlng;
  var CEndingPlat;
  var CEndingPlng;

  var OSEPolyline;
  var SEPolyline;

  var markerS;
  var markerD;
  var putTaxi;    
  var putPsg;

  var animatedMarker;
  var polyline_123;

  var g_puid;  
  var g_tuid;

  var PsgLayer = {};
  var TaxiCurLayer = {};
  var PsgCurLayer = {};
  var vpopupinfo;
  var ecPopup = new EC.Popup();
  var ecPopup_format = 0 ;

  map.setView([15.243196,104.8601933], 14);

  map.on('draw:created', function (e) {
    var type = e.layerType,
    layer = e.layer;
    map.addLayer(layer);
  });

var curlng = 104.8601933 ;
var curlat = 15.243196;


/*
getinitiatelist();
function getinitiatelist(){
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/ubeam/getinitiatelist",
	      dataType: "json", 
	      data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":10000, \"amount\":500 } ", 			     
	     success: function(data){
		for (var i = 0; i < data.data.length; i++) {		    
		    $(".table-list").append('<tr><td>'+data.data[i].updated+'</td><td>'+data.data[i].phone+'</td><td>'+data.data[i].curaddr+'</td><td>'+data.data[i].destination+'</td><td><input type="radio" value="'+data.data[i]._id+'" name="'+data.data[i]._id+'" >!DO!</td></tr>');
		}	     	
	        	//console.log(data.data[0]._id);
	        	
	     } 
	 });
}
*/

getpsgstatuslistON();
getpsgstatuslistMANUAL();

setInterval(function() {
	getpsgstatuslistON();
},	10000);
function getpsgstatuslistON() {
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/ubeam/getpsgstatuslist",
	      dataType: "json", 
	      data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":10000, \"amount\":500, \"status\": \"ON\" } ", 			     
	     success: function(data){	     	
		$(".table-list-on").empty();
		var tt ='<table class="table-list-on" width="95%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><th colspan="5">[ List of ON status = '+data.data.length+']</th></tr><tr><th width="15%">เวลา</th><th width="25%">โทรศัพท์</th><th width="20%">จุดรับ</th><th width="20%">จุดส่ง</th><th width="10%"></th></tr>';
                     	$(".table-list-on").html(tt);

		for (var i = 0; i < data.data.length; i++) {		    			
		    $(".table-list-on").append( '<tr><td>'+data.data[i].updated+'</td><td>'+data.data[i].phone+'</td><td>'+data.data[i].curaddr+'</td><td>'+data.data[i].destination+'</td><td></td></tr>');
		}

		$(".table-list-on").append('</tbody></table>') ;
	        	//console.log(data.data[0]._id);
	        	
	     } 
	 });
}


setInterval(function() { 			
	getpsgstatuslistMANUAL();
},	10000);
function getpsgstatuslistMANUAL() {
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/ubeam/getpsgstatuslist",
	      dataType: "json", 
	      data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":10000, \"amount\":500, \"status\": \"MANUAL\" } ", 			     
	     success: function(data){	     	
		$(".table-list-manual").empty();
		var tt ='<table class="table-list-manual" width="95%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><th colspan="5">[ List of MANUAL status = '+data.data.length+']</th></tr><tr><th width="15%">เวลา</th><th width="25%">โทรศัพท์</th><th width="20%">จุดรับ</th><th width="20%">จุดส่ง</th><th width="10%"></th></tr>';
                     	$(".table-list-manual").html(tt);

		for (var i = 0; i < data.data.length; i++) {		    			
		    $(".table-list-manual").append( '<tr><td>'+data.data[i].updated+'</td><td>'+data.data[i].phone+'</td><td>'+data.data[i].curaddr+'</td><td>'+data.data[i].destination+'</td><td></td></tr>');
		}	

		$(".table-list-manual").append('</tbody></table>') ;
	        	//console.log(data.data[0]._id);
	        	
	     } 
	 });
}




$(function(){
	//alert(document.location.hostname)

	if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {				      
//		       curlng =  position.coords.longitude ;
//		       curlat =  position.coords.latitude ;				      
		      getDrvarround( curlng, curlat,   1000000,500);
		      getPsgarround( curlng, curlat,   1000000,500);
		      console.log(0) ;
		    }, function() {
		      console.log("Can not get your location !!");
		      alert('Please turn on your location.');
		    });
		}


	setInterval(function() { 			
		getDrvarround( curlng, curlat,   1000000,500);
	},	10000);


	checkCenter(function(  ){
	});			

});



function getTaxibemList(a){
	alert(a);
}


function checkCenter(callback){
	if(navigator.geolocation) {
	    navigator.geolocation.getCurrentPosition(function(position) {
	     //console.log('lat =>'+position.coords.latitude+' || lon =>'+position.coords.longitude);
	      curlng =  position.coords.longitude ;
	      curlat =  position.coords.latitude ;
	      JsonData = { "type": "Point", "coordinates": [position.coords.longitude, position.coords.latitude], "lat": position.coords.latitude, "lng": position.coords.longitude, "time stamp" : [new Date(position.timestamp)], "tempid" : tempid }
	      //console.log(JsonData)	      
	      addPoiJson(JsonData);
	    }, function() {
	      alert('Can not get your location, please allow browser to get your location.');
	    });
	}			
	//getAllPassenger();	
}



function getDrvarround(curlng, curlat, radian, limits){
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/passengercs/searchDrv",
	      dataType: "json", 
	      data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":10000000, \"amount\":500 } ", 			     
	     success: function(data){
	        	addPoiTaxi(data);
	     } 
	 });

}



function getPsgarround(curlng, curlat, radian, limits){		
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/ubeam/searchPsg",
	      dataType: "json", 
	      data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":10000, \"amount\":500 } ", 			     
	     success: function(data){
	        	//console.log(data);
	        	addPoiAllPsg(data);
	     } 
	 });
}



function addPoiTaxi(JsonData) {
	/*
var myIcon = L.icon({			 	
 	iconUrl: '../assets/img/map/pin-taxi-40.png',
 	//shadowUrl: 'img/map/leaf-shadow.png'
	iconAnchor: [20, 20]			 	
 });	
 	*/
 var myIcon;	 
 var myStyle = {
 	color: '#f00',
 	fillColor: '#ffc4c4',
 	weight: 2,
 	opacity: 0.8,
 	//iconUrl: 'img/map/taxi_pin.png'
 	icon: myIcon
 	
 };	
	//test = JsonData;
	$.each(JsonData.data, function(i, item) {

	var DrvDetail = '<b>ชื่อ</b>: '+item.fname+' '+item.lname+'<br><b>โทรศัพท์</b>: <a href="tel:'+item.phone+'" ><font color="white">'+item.phone+'</font></a><br><b>ทะเบียน</b>: '+item.carplate+'<br><b>สถานะ</b>:'+item.status ;
	//DrvDetail = document.location.hostname+'/image/driver/'+item.imgface+'<br>';
	if( item.imgface != '' ){
	DrvDetail += '<br><img src="http://'+document.location.hostname+'/image/driver/'+item.imgface+'" width="150" ><br>' ;	
	}

         	tempmk = item._id;

                if(map.hasLayer(TaxiCurLayer[tempmk])) {
                  map.removeLayer(TaxiCurLayer[tempmk]);
                }   

	var myIcon = L.icon({			 	
	 	iconUrl: '../assets/img/map/pin-taxi-'+item.status+'.png',
	 	//shadowUrl: 'img/map/leaf-shadow.png'
		iconAnchor: [20, 20],
		labelAnchor:[10,0]		 	
	 });
	var tlabel =  item.carplate ; 
       	TaxiCurLayer[tempmk] = new L.marker([item.curlat,item.curlng], {icon: myIcon, style: myStyle}).bindLabel( tlabel ,{ noHide:true ,direction: 'auto' ,className:'label_taxi_'+item.status } ).bindPopup(DrvDetail) ;
     	map.addLayer( TaxiCurLayer[tempmk] );	
	 //	putMarker = new L.marker([item.curlat,item.curlng], {icon: myIcon, style: myStyle}).bindPopup(DrvDetail) ;
	//	map.addLayer(putMarker);	


	});
}


function addPoiAllPsg(JsonData) {
var myIcon = L.icon({			 	
 	iconUrl: '../assets/img/map/pin-passenger.png',
 	//shadowUrl: 'img/map/leaf-shadow.png'
	iconAnchor: [20, 20]			 	
 });		 
 var myStyle = {
 	color: '#f00',
 	fillColor: '#ffc4c4',
 	weight: 2,
 	opacity: 0.8,
 	icon: myIcon,			
 	iconUrl: 'img/map/pin-passenger.png'
 };	
	test = JsonData;
	$.each(JsonData.data, function(i, item) {
	//console.log(i)
	//console.log(item)
	//console.log(item.curlat +' , '+item.curlng) ;			  
	 	putMarker = new L.marker([item.curlat,item.curlng], {icon: myIcon, style: myStyle}).bindPopup( '<b>อีเมล์</b>: '+item.email+'<br><b>โทรศัพท์</b>: <a href="tel:'+item.phone+'"><font color="white">'+item.phone+'</font></a><br><b>ปลายทาง</b>: '+item.destination+'<br>' ) ;
		map.addLayer(putMarker);			  
	});
}



$(function() {  	
	$("#placenearby").autocomplete({ 
	    source: function (request, response) { 
	        $.ajax({ 
	            type: "POST", 
	            contentType: "application/json; charset=utf-8", 
	            url: "https://locator.ecartmap.com/locator/poi", 
	            dataType: "json", 
	            data: "{'Name':'" + request.term + "'   , 'Language': 'TH'  }", 
	            success: function (data) { 
	            	//console.log(data)
	           		response($.map(data, function (item) {                			
	            	    return { 
	                	    //label: item.Name + '(' + item.Value + ')',
	                        label: item.Name, value: item.Name, latlng: item.Lat+','+item.Long
	                        } 
	                    }	//return
	                    )	//(data
	           		)		//$.map
	            } 
	        }); 
	    }, 
	    minLength: 2, 
	    select: function (event, ui) {      		
	  		var setlatlng = ui.item.latlng; 
	  		//alert(setlatlng);
	  		//map.setView([.split','],15);
	  		map.setView(setlatlng.split(','),13)
	    }, 
	    open: function () { 
	        $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
	    }, 
	    close: function () { 
	        $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
	    }, 
	    error: function (XMLHttpRequest, textStatus, errorThrown) { 
	        alert(textStatus); 
	    } 
	}); 
});




$(function() {  	
	$("#drivernearby").autocomplete({ 
	    source: function (request, response) { 
	        $.ajax({ 
	            type: "POST", 
	            contentType: "application/json; charset=utf-8", 
	            url: "../service/ubeam/searchnamecar", 
	            dataType: "json", 
	            data: "{  \"keyword\" : \"" + request.term + "\"     }", 
	            success: function (data) { 
	            		console.log(data.data)
	            		//var ssddrvid = data.data[0]._id;
	            		//alert(ssddrvid)
	           		response($.map(data.data, function (item) {    

	            	    return { 
	                	    //label: item.Name + '(' + item.Value + ')',
	                        //label: item.fname+' '+item.lname+' : '+item.carplate,   value: item._id,   latlng: item.curlat+','+item.curlng
	                        label: item.fname+' '+item.lname+' : '+item.carplate ,   value: item.fname+' '+item.lname+' : '+item.carplate ,  id: item._id  ,  latlng: item.curlat+','+item.curlng
	                        } 
	                    }	//return
	                    )	//(data
	           		)		//$.map
	            } 
	        }); 
	    }, 
	    minLength: 2, 
	    select: function (event, ui) {      	
	    		//console.log(ui)	
	  		var setlatlng = ui.item.latlng; 
	  		var ssddrvid = ui.item.id; 
	  		//alert(setlatlng);
	  		//map.setView([.split','],15);
	  		map.setView(setlatlng.split(','),17)

	  		showdialogsearchnamecar(ssddrvid);

	    }, 
	    open: function () { 
	        $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
	    }, 
	    close: function () { 
	        $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
	    }, 
	    error: function (XMLHttpRequest, textStatus, errorThrown) { 
	        alert(textStatus); 
	    } 
	}); 
});



  $(function() {
  $('#btn_panel_on').click() ;
    $( "#taxiSplate" ).focus(function() {
      $( "aside[id=subNav]" ).removeClass( "hide" );  
    });

    $( "#psgSphone" ).focus(function() {
      $( "aside[id=subNav]" ).removeClass( "hide" );  
    });        

  });



  function getPINAllDevices() {     
  console.log('getPINAllDevices')
    $.ajax({
        url : "/service/getInitDevices",
        type: "GET",
        success: function(JsonData){
            console.log('success getPINAllDevices')
            console.log(JsonData);

            $.each(JsonData.data, function(i, item) {  
        console.log(item.latitude+','+item.longitude+':'+item.status)
              var myIcon = L.icon({
                iconUrl: '/assets/img/map/pin_'+item.carType+'_'+item.status+'.png',
                  iconSize: [50,50],
                  iconAnchor: [25,25],
                  shadowUrl: null  
              });   

              console.log('/assets/img/map/pin_'+item.carType+'_'+item.status+'.png')
              
        var tempmk = item.uid;

              if (item.status == 1||item.status == 3||item.status == 4) {
                if(map.hasLayer(TaxiCurLayer[tempmk])) {
                  map.removeLayer(TaxiCurLayer[tempmk]);
                }    
                
                vpopupinfo = '<b>License:</b> '+item.carLicense+'<br><b>Type:</b> '+item.carType+'<br><b>พิกัด:</b> '+ item.latitude +' , '+ item.longitude + '<br><b>Altitude:</b> ' + item.altitude + '<br><b>Decibels:</b> ' + item.decibels + '<br><b>Light:</b> ' + item.light + '<br><b>Carspeed:</b> ' + item.carSpeed + '<br><b>Accuracy:</b> ' + item.direction.accuracy;   
                
             //   $("#vpopupinfo").html(vpopupinfo);
                /*
                TaxiCurLayer[tempmk] = new L.marker([item.latitude,item.longitude], {icon: myIcon, angle:item.direction.degree}).whitePopup('License: '+item.carLicense+'<br>Type: '+item.carType+'<br>พิกัด: '+ item.latitude +' , '+ item.longitude + '<br>Altitude: ' + item.altitude + '<br>Decibels: ' + item.decibels + '<br>Light: ' + item.light + '<br>Carspeed: ' + item.carSpeed + '<br>Accuracy: ' + item.direction.accuracy);
        */
                  TaxiCurLayer[tempmk] = new L.marker([item.latitude,item.longitude], {icon: myIcon, angle:item.direction.degree});
          
        
        TaxiCurLayer[tempmk].on("click", function (e) {
             var id2 = tempmk ;      
            ecPopup_format++ ;
            if ( ecPopup_format > 9 ) { ecPopup_format = 0 ;}
             if(!ecPopup.hasPopup(id2)) {
               ecPopup.addPopup(
                 {
                 id: id2,
                 title: id2 ,
                 content: vpopupinfo ,
                 },
                 {
                   width: 200,
                   height:230,
                   focus: ecPopup_format,
                   flatlng:[item.latitude,item.longitude]                   
                 }
               );
             }
          });   
            
        
          console.log( ' TaxiCurLayer ' ) ;
        
                map.addLayer(TaxiCurLayer[tempmk]);
        
              } else {
                if(map.hasLayer(TaxiCurLayer[tempmk])) {
                  map.removeLayer(TaxiCurLayer[tempmk]);
                }
              } 

            });
        }
    });      
  } 



  function getPINAllPassengers() {   
  console.log('getPINAllPassenger')
    $.ajax({
        url : "/service/getInitPassengers",
        type: "GET",
        success: function(JsonData){
            console.log('success getPINAllPassenger')
            console.log(JsonData);
             //addPoiJson(data.geoJson);
            console.log('hey!!!!!! Pin Psg-location... ');    

            $.each(JsonData.data, function(i, item) {              
              
              var PsgmyIcon = L.icon({
                iconUrl: '/assets/img/map/pin-passenger'+item.status+'.png',
                  iconSize: [50,50],
                  iconAnchor: [25,25],
                  shadowUrl: null
              });  

              var tempmk = item.uid;

              if (item.status == 1||item.status == 3||item.status == 4) {
                if(map.hasLayer(PsgCurLayer[tempmk])) {
                  map.removeLayer(PsgCurLayer[tempmk]);
                }         
                PsgCurLayer[tempmk] = new L.marker([item.latitude,item.longitude], {icon: PsgmyIcon}).whitePopup('ID: '+item.uid+'<br>Phone: '+item.phoneNumber+'<br>Address: '+item.address+'<br>Location: '+ item.latitude +' , '+ item.longitude + '<br>Tips : ' + item.tips +'<br>Altitude: ' + item.altitude +'<br>Accelerometer: ' + item.accelerometer + '<br>Decibels: ' + item.decibels + '<br>Light: ' + item.light + '<br>Destination: ' + item.destination.name + '<br>Distance: '+ item.distance + '<br>Action : '+ item.action +'<br>Status: ' + item.status );
                map.addLayer(PsgCurLayer[tempmk]);
              } else {
                if(map.hasLayer(PsgCurLayer[tempmk])) {
                  map.removeLayer(PsgCurLayer[tempmk]);
                }
              }             

            });
  
        }
    });      
  }



/***********************end initiate pin**********************************/



  $(function() {    
    $("#psgnearby").autocomplete({ 
        source: function (request, response) { 
            $.ajax({ 
                type: "POST", 
                contentType: "application/json; charset=utf-8", 
                url: "http://locator-dev.ecartmap.com/locator/poi", 
                dataType: "json", 
                data: "{'Name':'" + request.term + "'}", 
                success: function (data) { 
                  //console.log(data)
                  response($.map(data, function (item) {                      
                      return { 
                          //label: item.Name + '(' + item.Value + ')',
                            label: item.Name, value: item.Name, latlng: item.Lat+','+item.Long
                            } 
                        } //return
                        ) //(data
                  )   //$.map
                } 
            }); 
        }, 
        minLength: 2, 
        select: function (event, ui) {          
          var setlatlng = ui.item.latlng; 
          //alert(setlatlng);
          //map.setView([.split','],15);
          map.setView(setlatlng.split(','),13)
        }, 
        open: function () { 
            $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
        }, 
        close: function () { 
            $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(textStatus); 
        } 
    }); 
  });
  
  

  $(function() {    
    $("#psgSphone").autocomplete({ 
        source: function (request, response) { 
        var data = {
          phoneNumber : $('#psgSphone').val(),
        };        
        //var dataphone = { phoneNumber: '0843112347' } 
            $.ajax({ 
                type: "POST", 
                //contentType: "application/json; charset=utf-8", 
                url: "/service/getPsgbyPhone", 
                dataType: "json",                 
                //data: "{'phoneNumber':'" + request.term + "' }", 
                data: data,
                success: function (data) {                    
                  response($.map(data.data, function (item) {                     
                      return {
                            label: item.phoneNumber, value: item.phoneNumber, uid: item.uid
                            } 
                        } //return
                        ) //(data
                  )   //$.map
                } 
            });
        }, 
        minLength: 2, 
        select: function (event, ui) {
          g_puid = ui.item.uid;          
        }, 
        open: function () { 
            $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
        }, 
        close: function () { 
            $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(textStatus); 
        } 
    });
  });
  
  
  
  $(function() {    
    $("#psgsSname").autocomplete({ 
        source: function (request, response) { 
        var data = {
          name : $('#psgsSname').val(),
        };                
            $.ajax({ 
                type: "POST",                 
                url: "/service/getPsgbyName", 
                dataType: "json",                                 
                data: data,
                success: function (data) {                    
                  response($.map(data.data, function (item) {                     
                      return {
                            label: item.name, value: item.name, uid: item.uid
                            } 
                        } //return
                        ) //(data
                  )   //$.map
                } 
            });
        }, 
        minLength: 2, 
        select: function (event, ui) {
        }, 
        open: function () { 
            $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
        }, 
        close: function () { 
            $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(textStatus); 
        } 
    });
  });
  
  
  

  $(function() {    
    $("#taxiSplate").autocomplete({ 
        source: function (request, response) { 
        var data = {
          carLicense : $('#taxiSplate').val(),
        };                
            $.ajax({ 
                type: "POST",                 
                url: "/service/getDvbyPlate", 
                dataType: "json",                                 
                data: data,
                success: function (data) {                    
                  response($.map(data.data, function (item) {                   
                      return {
                            label: item.carLicense, value: item.carLicense, uid: item.uid                        
                            } 
                        } //return
                        ) //(data
                  )   //$.map
                } 
            });
        }, 
        minLength: 2, 
        select: function (event, ui) {
          g_tuid = ui.item.uid;
        }, 
        open: function () { 
            $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
        }, 
        close: function () { 
            $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(textStatus); 
        } 
    });
  });
  
  
  
  $(function() {    
    $("#taxiSphone").autocomplete({ 
        source: function (request, response) { 
        var data = {
          phoneNumber : $('#taxiSphone').val(),
        };                
            $.ajax({ 
                type: "POST",                 
                url: "/service/getDvbyPhone", 
                dataType: "json",                                 
                data: data,
                success: function (data) {                    
                  response($.map(data.data, function (item) {                     
                      return {
                            label: item.phoneNumber, value: item.phoneNumber, uid: item.uid
                            } 
                        } //return
                        ) //(data
                  )   //$.map
                } 
            });
        }, 
        minLength: 2, 
        select: function (event, ui) {
        }, 
        open: function () { 
            $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
        }, 
        close: function () { 
            $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
        }, 
        error: function (XMLHttpRequest, textStatus, errorThrown) { 
            alert(textStatus); 
        } 
    });
  });
  

  
  // Get Search List
  function getPSearchList_node(){
    var data = {
      psgSphone : $('#psgSphone').val(),
      psgsSname : $('#psgsSname').val(),      
      DPstart: $('#DPstart').val(),
      DPend: $('#DPend').val(),
    };

    $.ajax({
        url : "/service/getPSearchList",
        type: "POST",
        data: data,
        success: function(data){
            //console.log(data)
        }
    }); 
  }



  function getPSearchList(){
    /*
    var data = {      
      taxiSplate1: g_tuid ,//$('#taxiSplate').val(),
      taxiSphone: $('#taxiSphone').val(),
      DTstart: $('#DTstart').val(),
      DTend: $('#DTend').val(),
    };
    */
    ////
    var DPstart =  new Date($('#DPstart').val());  
    var stD = DPstart.toISOString();
    var DPend = new Date($('#DPend').val());  
    var enD = DPend.toISOString();
    $.ajax({
        /*   ----> Strong loop is working!!! ---*/
        url:"http://192.168.23.23:3000/api/pathlogs?access_token=12910310"+
            "&filter[fields][latitude]=true"+
            "&filter[fields][longitude]=true"+
            "&filter[fields][timeStamp]=true"+
            "&filter[fields][uid]=true"+
            "&filter[where][latitude][gt]0"+
            "&filter[where][uid]="+g_puid+                
            "&filter[where][and][0][timeStamp][gte]="+stD+
            "&filter[where][and][1][timeStamp][lte]="+enD+
            "&filter[limit]=100",
        //url:"/service/getPSearchList",
        type: "GET",        
        success: function(data){
            
        if(map.hasLayer(animatedMarker)) {
          map.removeLayer(animatedMarker);
        }
        if(map.hasLayer(polyline_123)) {
          map.removeLayer(polyline_123);
        }
        var json = data;
        var arr = []; 

        for(var i = 0; i < json.length; i++) {  
          arr.push([parseFloat(json[i].latitude),parseFloat(json[i].longitude)])
        };
        //console.log(arr[0]);
        map.setView(arr[0],13);
        polyline_123 = L.polyline(arr); // create polyline
        polyline_123.addTo(map);
        //console.log(arr);
        var line = L.polyline(arr);
        var myIcon = L.icon({
          iconUrl: '../assets/img/y-taxi-ico.png',
            iconSize: [25, 39],
            iconAnchor: [12, 39],
            shadowUrl: null         
          //iconUrl: 'img/marker-icon.png'          
        });       
        animatedMarker = L.animatedMarker(line.getLatLngs(), {
          icon: myIcon,
            //distance: 300,  // meters
            //interval: 2000, // milliseconds
            onEnd: function() {
              // TODO: blow up this marker
            }           
        });
        map.addLayer(animatedMarker);
        }
    }); 
  }



  // https://developers.google.com/maps/documentation/javascript/reference#Marker > Google Maps Javascript API V3 Reference
  // Get Search List
  function getTSearchList(){
    
    var data = {      
      taxiSplate: g_tuid ,//$('#taxiSplate').val(),
      taxiSphone: $('#taxiSphone').val(),
      DTstart: $('#DTstart').val(),
      DTend: $('#DTend').val(),
    };
    
    /* --- Use for Strongloop
    var DTstart =  new Date($('#DTstart').val());  
    var stD = DTstart.toISOString();
    var DTend = new Date($('#DTend').val()); 
    var enD = DTend.toISOString();
    */
    $.ajax({
        url:"/service/getTSearchList",
        type: "POST",
        data: data, 

        success: function(data){

        if(map.hasLayer(animatedMarker)) {
          map.removeLayer(animatedMarker);
        }
        if(map.hasLayer(polyline_123)) {
          map.removeLayer(polyline_123);
        }
        var json = data.data;
        var arr = []; 
        //console.log(json);
        //console.log(json.data);
        for(var i = 0; i < json.length; i++) {  
          arr.push([parseFloat(json[i].latitude),parseFloat(json[i].longitude)])
        };
        
        map.setView(arr[0],13);
        polyline_123 = L.polyline(arr); // create polyline
        polyline_123.addTo(map);
        //console.log(arr);
        var line = L.polyline(arr);
        var myIcon = L.icon({
          iconUrl: '../assets/img/y-taxi-ico.png',
            iconSize: [25, 39],
            iconAnchor: [12, 39],
            shadowUrl: null         
          //iconUrl: 'img/marker-icon.png'          
        });       
        animatedMarker = L.animatedMarker(line.getLatLngs(), {
          icon: myIcon,
            //distance: 300,  // meters
            //interval: 2000, // milliseconds
            onEnd: function() {
              // TODO: blow up this marker
            }           
        });

        map.addLayer(animatedMarker);
        }
    }); 
  }



  function getTSearchList_node(){
    var data = {      
      taxiSplate: g_tuid ,//$('#taxiSplate').val(),
      taxiSphone: $('#taxiSphone').val(),
      DTstart: $('#DTstart').val(),
      DTend: $('#DTend').val(),
    };

    $.ajax({
        url : "/service/getTSearchList",
        type: "POST",
        data: data,
        //url : "http://localhost:3000/api/pathlogs?filter[fields][latitude]=true&filter[fields][longitude]=true&filter[where][latitude][gt]0",
        //type: "GET",        
        success: function(data){
            console.log(data)           
            //console.log('anchor')
           if(map.hasLayer(animatedMarker)) {
              map.removeLayer(animatedMarker);
           }
        if(map.hasLayer(polyline_123)) {
          map.removeLayer(polyline_123);
        }
        var json = data;
        var arr = [];       
        for(var i = 0; i < json.data.length; i++) {         
          arr.push([parseFloat(json.data[i].latitude),parseFloat(json.data[i].longitude)])
        };
        //console.log(arr[0]);
        map.setView(arr[0],13);
        polyline_123 = L.polyline(arr); // create polyline
        polyline_123.addTo(map);
        //console.log(arr);
        var line = L.polyline(arr);
        var myIcon = L.icon({
          iconUrl: '../assets/img/y-taxi-ico.png',
            iconSize: [25, 39],
            iconAnchor: [12, 39],
            shadowUrl: null         
          //iconUrl: 'img/marker-icon.png'          
        });       
        animatedMarker = L.animatedMarker(line.getLatLngs(), {
          icon: myIcon,
            //distance: 300,  // meters
            //interval: 2000, // milliseconds
            onEnd: function() {
              // TODO: blow up this marker
            }           
        });
        map.addLayer(animatedMarker);
        }
    }); 
  }



  $(function() {
    $( "#DPstart" ).datepicker({});
    $( "#DPend" ).datepicker({});
  });



  $(function() {
    $( "#DTstart" ).datepicker({
      //dateFormat: 'dd-mm-yy' 
    });
    $( "#DTend" ).datepicker({});
  });






function checkGPS(callback){    
	if(navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(position) {
			//console.log('lat =>'+position.coords.latitude+' || lon =>'+position.coords.longitude);
			JsonData = { "type": "Point", "coordinates": [position.coords.longitude, position.coords.latitude] }
			if( jsonPoiList != 0 ){ map.removeLayer(jsonPoiList); }
			addPoiJsongps(JsonData);
			callback();
			}, function() {
			console.log("Can not get your location !!");
		});
	}
}



function addPoiJsongps(JsonData) {  
	var myIcon = L.icon({iconUrl: 'http://leafletjs.com/dist/images/marker-icon.png'});     
	var myStyle = {
		color: '#f00',
		fillColor: '#ffc4c4',
		weight: 2,
		opacity: 0.8,
		icon: myIcon,     
		iconUrl: 'img/map/taxi_pin.png'
	};
	jsonPoiList = L.geoJson(JsonData, {
		style: myStyle
	});
	map.addLayer(jsonPoiList); 
	map.fitBounds(jsonPoiList.getBounds());
	map.setZoom(15);
}



function addPoi(JsonData) {
	//console.log('add poi');    
	var myIcon = L.icon({iconUrl: 'http://leafletjs.com/dist/images/marker-icon.png'});  
	var myStyle = {
		color: '#f00',
		fillColor: '#ffc4c4',
		weight: 2,
		opacity: 0.8,
		icon: myIcon,     
		iconUrl: 'img/map/taxi_pin.png'
	};

	$.each(JsonData.data, function(i, item) {
		//   console.log(item.lat +' , '+item.lng) ;       
		putMarker = new L.marker([item.lat,item.lng], {icon: myIcon, style: myStyle});
		map.addLayer(putMarker);        
	});

}



/* -----------------------------------------
Get passenger list (all)
----------------------------------------- */
function getAllPassenger () {
	// console.log('getAllPassenger');   
	// $.ajax({
	//     url : "/service/getPassenger/all",
	//     type: "GET",
	//     success: function(data){
	//          console.log(data);
	//          addPoiJson(data.geoJson);
	//     }
	// });
	socket.emit('get all passenger',{msg:'request get all passenger'});
	socket.on('show all passenger',function(data){
	//alert('her its html show all passenger !!');
	//   console.log(data);
	addPoi(data);
	});
}



  /* -----------------------------------------
      Get passenger by ID
    ----------------------------------------- */    
  function getPassengerById () {
    var data = {
      uid: '555',
      name: 'สมหมาย',
      carLicense: 'ดก-4448',
      lat: 13.3, 
      lng: 100.1,
      distance: 200,
      detail: '',
      status: 3
    };

    $.ajax({
        url : "/service/getPassenger/5555",
        type: "POST",
        data : data,
        success: function(data){
            console.log(data)
        }
    });
  }




  /* -----------------------------------------
      Get passenger
       ----------------------------------------- */

  function updatePassenger () {
    var data = {
      uid: '555',
      registrationId: 'sdfadsgjakfdg',
      name: 'สมหมาย',
      carLicense: 'ดก-4448',
      lat: 13.33333333, 
      lng: 100.11243256,
      distance: 200,
      detail: '',
      passengerID: '',
      status: 1
    };

    $.ajax({
        url : "/service/getPassenger",
        type: "POST",
        data : data,
        success: function(data){
            console.log(data)
        }
    });
  }

  

  /* -----------------------------------------
    POST Taxi need to cancel passenger 
       ----------------------------------------- */

function updateDevice () {
	var data = {
		uid: '555',
		name: 'สมหมาย',
		carLicense: 'ดก-4448',
		lat: 13.456, 
		lng: 100.11243256,
		distance: 4564,
		detail: '',
		passengerID: '0001',
		status: 1
	};
	$.ajax({
		url : "service/device/updateStatus",
		type: "POST",
		data : data,
		success: function(data){
			console.log(data)
		}
	});
}


  /* -----------------------------------------
    POST Taxi need to picup passenger
       ----------------------------------------- */

function updateDeviceWaiting () {
	var data = {
		uid: '555',
		name: 'สมหมาย',
		carLicense: 'ดก-4448',
		lat: 13.456, 
		lng: 100.11243256,
		distance: 4564,
		detail: '',
		passengerID: '0001',
		status: 5
	};
	$.ajax({
		url : "service/device/updateStatus",
		type: "POST",
		data : data,
		success: function(data){
			console.log(data)
		}
	});
}




/* -----------------------------------------
Get Taxi
----------------------------------------- */
function getallTaxiListInterval(){      
	getallTaxiList();   
	setInterval(function() {      
		getallTaxiList();       
	},  40000);
}



function getallTaxiList_socket() {    
	//socket.emit('get all device',{msg:'request get all device'});
	socket.on(' show all device',function(data){      
		console.log(data);
		addPoiJson(data);
	});
}


function getallTaxiList() {
	/*
	var data = {
	uid: '5555',
	registrationId: 'ljfglkdf',
	name: 'สมบัติ',
	phoneNumber: '0843112347',
	lat: 13.0, 
	lng: 100.9,
	distance: 200,
	detail: '',
	destination: 'กรุงเทพ',
	status: 1
	};
	*/    
	$.ajax({
		url : "/service/getDeviceSocket/all",
		type: "GET",        
		success: function(data){              
			if(map.hasLayer(putTaxi)) {
				map.removeLayer(putTaxi);
			}
			addPoiJson(data);
		}
	});
}



function addPoiJson(JsonData) {
	// console.log(putTaxi);
	var myIcon = L.icon({      
		//shadowUrl: 'img/map/leaf-shadow.png',
		iconUrl: 'img/map/taxi_pin.png',
		//iconSize: [25, 39],
		//iconAnchor: [12, 39],
		shadowUrl: null       
	});
	var myStyle = {
		color: '#f00',
		fillColor: '#ffc4c4',
		weight: 2,
		opacity: 0.8,
		icon: myIcon,     
		iconUrl: 'img/map/taxi_pin.png'
	}; 

	//console.log(map.hasLayer(putTaxi))

	if(map.hasLayer(putTaxi)) {
		map.removeLayer(putTaxi);
	}       

	$.each(JsonData.data, function(i, item) {
		console.log(item.latitude +' , '+item.longitude) ;        
		putTaxi = new L.marker([item.latitude,item.longitude], {icon: myIcon, style: myStyle, angle:item.direction.degree}).whitePopup("<b>"+item.name+"</b><br />Plate:"+item.carLicense+'<br>พิกัด'+ item.latitude +','+ item.longitude );
		map.addLayer(putTaxi);  
	});
}



function getallPsgListInterval(){ 
	getallPsgList();    
	setInterval(function() {      
		getallPsgList();
	}, 10000);
}



function getallPsgList() {
	var data = {
		uid: '555',
		registrationId: 'sdfadsgjakfdg',
		name: 'สมหมาย',
		carLicense: 'ดก-4448',
		lat: 13.33333333, 
		lng: 100.11243256,
		distance: 200,
		detail: '',
		passengerID: '',
		status: 1
	};      
	$.ajax({
		url : "/service/getPassenger",
		type: "POST",
		data : data,
		success: function(data){              
			if(map.hasLayer(putPsg)) {
				map.removeLayer(putPsg);
			}
			addPoiJsonPsg(data);
		}
	});
}



function addPoiJsonPsg(JsonData) {
	//console.log(putPsg);
	var myIcon = L.icon({       
		iconUrl: 'img/map/pin-passenger.png',
		shadowUrl: 'img/map/leaf-shadow.png'
	});
	var myStyle = {
		color: '#f00',
		fillColor: '#ffc4c4',
		weight: 2,
		opacity: 0.8,
		icon: myIcon,     
		iconUrl: 'img/map/pin-passenger.png'
	};   
	// console.log(map.hasLayer(putTaxi))             
	$.each(JsonData.data, function(i, item) {
		console.log(item.lat +' , '+item.lng) ; 
		putPsg = new L.marker([item.lat,item.lng], {icon: myIcon, style: myStyle}).whitePopup("<b>"+item.name+"</b><br />Plate:"+item.phoneNumber+'<br>พิกัด'+ item.lat +','+ item.lng );
		map.addLayer(putPsg); 
	});
}




  /* -----------------------------------------
      Get Taxi list (all)
       ----------------------------------------- */
function getAllTaxi () {
	$.ajax({
		url : "/service/getDevice/all",
		type: "GET",
		success: function(data){
		//console.log(data)
		}
	});
}



function PinStart(){
	var myIcon = L.icon({
		iconUrl: '../img/map/pin-passenger.png',
		// iconRetinaUrl: 'my-icon@2x.png',
		// iconSize: [38, 95],
		iconAnchor: [25, 25],
		// popupAnchor: [-3, -76],
		// shadowUrl: 'my-icon-shadow.png',
		// shadowRetinaUrl: 'my-icon-shadow@2x.png',
		// shadowSize: [68, 95],
		// shadowAnchor: [22, 94]
	});

	var pinCenter = map.getCenter();      
	markerS = L.marker(pinCenter,{icon: myIcon, draggable: true });     
	markerS.bindLabel('Start', {noHide: true});
	markerS.addTo(map);
	map.setView(pinCenter,15);
	//markerS.dragging.enable();
	markerS.on('dragend', function(e) {         
		//CStartingP = markerS.getLatLng();
		CStartingPlat = markerS.getLatLng().lat;
		CStartingPlng = markerS.getLatLng().lng;          
		//markerS.bindPopup('<p>Please confirm the starting point<br><center><input type="button" value="START"></center></p>').openPopup();

		$.ajax({
			url : "http://proxy.hmap-dev.ecartmap.com/getDirection.php?url=https%3A//maps.googleapis.com/maps/api/directions/json%3Forigin%3D"+CStartingPlat+"%2C"+CStartingPlng+"%26destination%3D"+CEndingPlat+"%2C"+CEndingPlng+"%26waypoints%3Doptimize%3Atrue%26mode%3Ddriving%26language%3DTH%26sensor%3Dfalse%26key%3DZNViRo_sRGCtsSc3BeC280Rlprg%3D%26client%3Dgme-ecartstudiocompany&dummy=0.5774756167083979%20200%20OK%201417ms",
			type: "GET",
			success: function(data){
				var enc = data.routes[0].overview_polyline.points;
				var straddr = data.routes[0].legs[0].start_address;
				var endaddr = data.routes[0].legs[0].end_address;
				var tim = data.routes[0].legs[0].duration.text;
				var dis = data.routes[0].legs[0].distance.text;

				$('#FromDir').text(straddr);
				$('#ToDir').text(endaddr);
				$('#DistanceDir').text(dis);
				$('#TimeDir').text(tim);

				var polyDecode = map.navigation._decodeGoogle(enc);
				if (OSEPolyline!=undefined) {               
					map.removeLayer(OSEPolyline);
					OSEPolyline = L.polyline(polyDecode).addTo(map);
				} else {
					OSEPolyline = L.polyline(polyDecode).addTo(map);
				}
				//console.log(data);
				$("#idirection").show();
			}
		});

	});     
}



function PinDestination(){
	//http://proxy.hmap-dev.ecartmap.com/getDirection.php?url=https%3A//maps.googleapis.com/maps/api/directions/json%3Forigin%3D13.76339577962447%2C100.3546142578125%26destination%3D13.92073799964004%2C100.55511474609375%26waypoints%3Doptimize%3Atrue%26mode%3Ddriving%26language%3DTH%26sensor%3Dfalse%26key%3DZNViRo_sRGCtsSc3BeC280Rlprg%3D%26client%3Dgme-ecartstudiocompany&dummy=0.5774756167083979%20200%20OK%201417ms
	var myIcon = L.icon({
		iconUrl: '../img/map/pin-destination.png',
		// iconRetinaUrl: 'my-icon@2x.png',
		// iconSize: [38, 95],
		iconAnchor: [25, 25],
		// popupAnchor: [-3, -76],
		// shadowUrl: 'my-icon-shadow.png',
		// shadowRetinaUrl: 'my-icon-shadow@2x.png',
		// shadowSize: [68, 95],
		// shadowAnchor: [22, 94]
	});
	var pinCenter = map.getCenter();      
	markerD = L.marker(pinCenter, {icon: myIcon, draggable: true});
	markerD.bindLabel('Destination', {noHide: true});
	markerD.addTo(map);
	map.setView(pinCenter,15);
	//markerD.dragging.enable();

	markerD.on('dragend', function(e) {         
		//CEndingP = markerD.getLatLng();
		CEndingPlat = markerD.getLatLng().lat;
		CEndingPlng = markerD.getLatLng().lng;
		$.ajax({          
			url : "http://proxy.hmap-dev.ecartmap.com/getDirection.php?url=https%3A//maps.googleapis.com/maps/api/directions/json%3Forigin%3D"+CStartingPlat+"%2C"+CStartingPlng+"%26destination%3D"+CEndingPlat+"%2C"+CEndingPlng+"%26waypoints%3Doptimize%3Atrue%26mode%3Ddriving%26language%3DTH%26sensor%3Dfalse%26key%3DZNViRo_sRGCtsSc3BeC280Rlprg%3D%26client%3Dgme-ecartstudiocompany&dummy=0.5774756167083979%20200%20OK%201417ms",
			type: "GET",
			success: function(data){
				var enc = data.routes[0].overview_polyline.points;
				var straddr = data.routes[0].legs[0].start_address;
				var endaddr = data.routes[0].legs[0].end_address;
				var tim = data.routes[0].legs[0].duration.text;
				var dis = data.routes[0].legs[0].distance.text;

				$('#FromDir').text(straddr);
				$('#ToDir').text(endaddr);
				$('#DistanceDir').text(dis);
				$('#TimeDir').text(tim);              

				var polyDecode = map.navigation._decodeGoogle(enc);             
				if (OSEPolyline!=undefined) {               
					map.removeLayer(OSEPolyline);
					OSEPolyline = L.polyline(polyDecode).addTo(map);
				} else {
					OSEPolyline = L.polyline(polyDecode).addTo(map);
				}
				$("#idirection").show();
				//console.log(dis);
				//console.log(tim);
				//console.log(data);
				//map.clearLayer();
			}
		});
		//markerD.bindPopup('<p>Please confirm the destination point<br><center><input type="button" value="DESTINATION"></center></p>').openPopup();
	});     
}



  function LbisLocatorClear(){
	map.removeLayer(markerS); 
	map.removeLayer(markerD); 
	map.removeLayer(OSEPolyline);
	$('#FromDir').text('');
	$('#ToDir').text('');
	$('#DistanceDir').text('');
	$('#TimeDir').text('');         
	//map.removeLayer(putTaxi);
  }


  
  function LbisLocatorClose(){
	map.removeLayer(markerS); 
	map.removeLayer(markerD); 
	map.removeLayer(OSEPolyline);
	$('#FromDir').text('');
	$('#ToDir').text('');
	$('#DistanceDir').text('');
	$('#TimeDir').text('');         
	$("#idirection").hide();
  }


/*
  socket.on('ShowPsgLocation', function (data) {          
	//console.log(data);
	addPoiPsg(data);
  });

  socket.on('testsocketb1115', function (data) {          
	console.log(data);
	//addPoiPsg(data);
  });
*/

function addPoiPsg(JsonData) {
	//console.log('add poi');    
	var myIcon = L.icon({iconUrl: '/assets/img/map/pin-passenger.png'});
	var myStyle = {
		color: '#f00',
		fillColor: '#ffc4c4',
		weight: 2,
		opacity: 0.8,
		icon: myIcon,     
		iconUrl: 'img/map/pin-passenger.png'
	};
	console.log('hey!!!!!! น้องไอยรา ... ');
	//console.log(JsonData.tempid);
	console.log(JsonData.tempid);
	var tempmk = JsonData.tempid;

	if(map.hasLayer(PsgLayer[tempmk])) {
		map.removeLayer(PsgLayer[tempmk]);
	}

	PsgLayer[tempmk] = new L.marker([JsonData.coordinates[1],JsonData.coordinates[0]], {icon: myIcon, style: myStyle}).whitePopup('<b>พิกัด '+ JsonData.coordinates[1] +' , '+ JsonData.coordinates[0]);
	//console.log(PsgLayer[tempmk])
	map.addLayer(PsgLayer[tempmk]); 
	//map.fitBounds(jsonPoiList.getBounds());
	//map.setView([JsonData.coordinates[1],JsonData.coordinates[0]],15);          
	/*
	$.each(JsonData, function(i,item) {
	console.log(item);
	//console.log(item.coordinates);
	//console.log(item.lat +' , '+item.lng) ;       
	putMarker = new L.marker([item.lat,item.lng], {icon: myIcon, style: myStyle});
	map.addLayer(putMarker);        
	});
	*/
	/*
	for (temp in JsonData) {
	console.log(JsonData[temp])
	console.log(temp)
	}
	*/
}









 function showdialogsearchnamecar(drvid){
	//$( "#dialogsearchnamecar" ).dialog();
	//if(drvid) {alert(drvid);}
	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/drivercs/getByID",
	      dataType: "json", 
	      data: " { \"_id\": \""+drvid+"\"} ", 			     
	     success: function(item){
	        	//console.log(data);
	        	//addPoiAllPsg(data);

		var DrvDetail = '<b>ชื่อ</b>: '+item.data.fname+' '+item.data.lname+'<br><b>โทรศัพท์</b>: <a href="tel:'+item.data.phone+'" ><font color="white">'+item.data.phone+'</font></a><br><b>ทะเบียน</b>: '+item.data.carplate+'<br><b>สถานะ</b>:'+item.data.status ;
		//DrvDetail = document.location.hostname+'/image/driver/'+item.imgface+'<br>';
		if( item.imgface != '' ){
		DrvDetail += '<br><img src="http://'+document.location.hostname+'/image/driver/'+item.data.imgface+'" width="150" ><br>' ;	
		}
		DrvDetail += '<br>เบอร์ลูกค้า : <input type="text" id="toDrvPhone"> <br> ช้อความ  &nbsp; : <textarea id="toDrvText"></textarea>'
	        	$("#dialogsearchnamecar").html( "<div id='sendmsgdrv'>"+DrvDetail+"</div>" );
	     } 
	 });	
	
	
	$("#dialogsearchnamecar").dialog({
		position: 'right',
		title: 'title',
		autoOpen: true,
		buttons: {
		"Send Msg": function() {
			//alert(" This function is not working yet.");
			sendMsgtoDrv( drvid , $('#toDrvPhone').val() , $('#toDrvText').val() );
			},
		"Close": function() {$(this).dialog("close");}
		},
		modal: false,
		overlay: {
			opacity: 0.5,
			background: "black"
		}
	});	
}


function sendMsgtoDrv(drvid, todrvphone, todrvtext){		

	 $.ajax({
	     type: "POST",
	     contentType: "application/json; charset=utf-8", 	     
	     url : "../service/ubeam/senddrvmsg",
	      dataType: "json", 
	      data: " { \"drvid\": \""+drvid+"\", \"todrvphone\": \""+todrvphone+"\", \"todrvtext\":\""+todrvtext+" \"} ", 			     
	     success: function(data){
	        	addPoiTaxi(data);
	     } 
	 });

}


// Example: http://www.amitpatil.me/ajax-table-adding-removing-rows-dynamically-using-javascript-animation/
$(document).ready(function(){
	$("#save").click(function(){
		ajax("save");
	});

	$("#add_new").click(function(){
		$(".entry-form").fadeIn("fast");	
	});

	$("#close").click(function(){
		$(".entry-form").fadeOut("fast");	
	});

	$("#cancel").click(function(){
		$(".entry-form").fadeOut("fast");	
	});

	$(".del").click("click",function(){
		ajax("delete",$(this).attr("id"));
	});

	function ajax(action,id){
		if(action =="save")
			data = $("#userinfo").serialize()+"&amp;action="+action;
		else if(action == "delete"){
			data = "action="+action+"&amp;item_id="+id;
		}
		$.ajax({
			type: "POST", 
			//url: "ajax.php", 
			// {"success":"1","row_id":1451288451,"fname":"1","lname":"2","email":"3","phone":"4"}
			url: "../service/ubeam/addjoblist",
			data : data,
			dataType: "json",
			success: function(response){
				if(response.success == "1"){
					if(action == "save"){
						/*
						$(".entry-form").fadeOut("fast",function(){
							$(".table-list").append("<tr><td>"+response.row_id.substring(0, 4)+"</td><td>"+Date.parse(response.wtime)+"</td><td>"+response.wphone+"</td><td>"+response.wstart+"</td><td><a id="+response.row_id+" class='del' href='#'>Delete</a></td></tr>");
							$(".table-list tr:last").effect("highlight", {
								color: '#4BADF5'
							}, 1000);
						});
						*/	
						$(".entry-form").fadeOut("fast",function(){ });	
						$('#curaddr').val('');
						$('#destination').val('');
						$('#phone').val('');
						getpsgstatuslistON();
					}else if(action == "delete"){
						var row_id = response.item_id;
						$("a[id='"+row_id+"']").closest("tr").effect("highlight", {
							color: '#4BADF5'
						}, 1000);
						$("a[id='"+row_id+"']").closest("tr").fadeOut();
					}
				}
			},
			error: function(res){
				alert("Unexpected error! Try again.");
			}
		});
	}
});







</script>

	
</html>