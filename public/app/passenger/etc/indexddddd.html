<!doctype html>
<html lang="en"> 
	<head>
		<meta content="charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="viewport" content="width=device-width initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />   		
		<title>Taxi-Beam: Passengers</title>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

		<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/js/bootstrap-dialog.min.js"></script>
 
		<link rel="stylesheet" href="../assets/css/font.css">	
		<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
		<script type="text/javascript" src="../assets/libs/jquery/dist/jquery.js"></script>
		<script type="text/javascript" src="../assets/libs/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>		
		<script src="/socket.io/socket.io.js"></script>
		<script src="../assets/libs/jquery/dist/jquery.min.js"></script>		
		<script src="//code.jquery.com/jquery-1.10.2.js"></script>
		<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
		<script src="../assets/libs/angular/angular.js"></script>
		<script src="route/app.js"></script>
		<script src="controller/mainpsg.ctrl.js"></script>
		<script src="http://hmap.ecartmap.com/v1/hobbit-loader.js"></script>
		
		<style>
			.bg { background-color: #1a2127; }
			.header {  position: absolute;color: #d3c14a; font-size: 30px; letter-spacing: 25px; margin-left: 25px; margin-top: 5px; text-align: center; height: 10%;width:100%; display: none;}
			.model-body {
				max-height: 200px;
			}
			.map-box { position: absolute; width: 100%; height: 60%;top:0%;}

			.menu-box { position: absolute;padding: 8px; top: 61%; width: 100%; height:30%; text-align: center;}
			.menu-box .menu-logo { height: 113px; margin-bottom: 15px; margin-left: -18px; }
			.menu-box ul {margin: 10px; background-color: #303940; border-top: 3px solid #D3C14A; box-shadow: 0 10px 20px -5px #000000; color: #9a9a9a; padding: 20px; list-style: none; }
			.menu-box ul li, .menu-box ul li > a { display: block; text-decoration: none; outline: none; height: 38px; line-height: 36px; padding: 0; color: #fff; margin-bottom: 10px; border-radius: 0; letter-spacing: 1px; }
			.menu-box ul li:last-child { margin: 0; }
			.menu-box span { color: #ffffff; font-weight: bold; clear: both;padding: 4px; width: 15%; display: inline-block; }
			.menu-box input[type="text"] { width: 70%; }
			.menu-box button { border: none; background: #0085E4; color: #ffffff; font-weight: bold; }
			.menu-box-row { margin-bottom: 5px; text-align: center -moz-center ;}
            .xmenu-box-row button { width: 80%; }
			.menu-dialog { position: absolute; top: 80%; width: 10%; height:10%; margin: 0 auto; left:0; right:0; }

			.process-loading-topic {position: absolute; top: 61%; margin: 10px; background-color: #303940; border-top: 3px solid #D3C14A; box-shadow: 0 10px 20px -5px #000000; color: #9a9a9a; padding: 20px; visibility: hidden;}
			.process-loading { position: absolute; margin:0 auto; width: 100%; height: 100%; top:10%; visibility: hidden;}

			#idirection {  width: 400px; height: 200px; background-color: #ccc; padding: 10px; line-height: 25px; position: absolute; top: 10px; left: 50px; z-index: 11; }

			/* start css for autocomplete  : http://www.pontikis.net/blog/jquery-ui-autocomplete-step-by-step */
			/* highlight results */
			.ui-autocomplete span.hl_results {
			    background-color: #ffff66;
			}
			 .box_inputa {
			 	padding: 3px;
			 	width: 60%;
			 }
			/* loading - the AJAX indicator */
			.ui-autocomplete-loading {
			    background: white url('../img/ui-anim_basic_16x16.gif') right center no-repeat;
			}
			 
			/* scroll results */
			.ui-autocomplete {
			    max-height: 250px;
			    overflow-y: auto;
			    /* prevent horizontal scrollbar */
			    overflow-x: hidden;
			    /* add padding for vertical scrollbar */
			    padding-right: 5px;
			}
			 
			.ui-autocomplete li {
			    font-size: 16px;
			}
			 
			/* IE 6 doesn't support max-height
			* we use height instead, but this forces the menu to always be this tall
			*/
			* html .ui-autocomplete {
			    height: 250px;
			}
			.menu-dialog{
				top: 5px;
				left: 1%;
			}
			#but_checkstatus{
				line-height: 0.7;
			}
			/* start css for autocomplete */

		</style>

	</head>	
<script> 

if ( localStorage.getItem('device_id') == null ) { 
	tempid = Math.floor(Math.random() * 999) + 9 + '-' + new Date().getTime();	
	localStorage.setItem('device_id', tempid );
}

//console.log(localStorage.getItem('device_id'));

</script>

	<body class="bg" ng-app="PassengersApp">
		<!-- header -->
		<div class="header">TAXI-BEAM Lite Passenger</div>




		<div id="idirection" style="display:none;" >
			<legend>Direction: </legend>
			<div >จาก : 	<font id="FromDir"></font></div>
			<div >ไป  : 		<font id="ToDir"></font></div>
			<div >Distance:	<font id="DistanceDir"></font></div>
			<div >Time: 	<font id="TimeDir"></font></div>			
			<div>
				<input type="button" id="ClearDir" value="Clear" onClick="LbisLocatorClear();" >
				<input type="button" id="ClearDir" value="Close" onClick="LbisLocatorClose();" >				
			</div>
			<div>&nbsp;</div>
		</div>




		<!-- map -->
		<div id="map" class="map-box"></div>

		<div class="menu-box">
			<div class="menu-box-row">
				<span>จาก </span><input type="text" name="psgfrom" id="psgfrom" class="box_input" maxlength="100" value="ตำแหน่งปัจจุบัน" placeholder="กรุณาพิมพ์ตำแหน่งปัจจุบัน" onClick="checkGPS();" />
			</div>
			<div class="menu-box-row">
				<span>ไป </span><input type="text" name="psgto" id="psgto" class="box_input" maxlength="100" placeholder="กรุณาพิมพ์จุดหมายปลายทาง" />
			</div>
			<div class="menu-box-row">
				<span>เบอร์ติดต่อ</span><input type="text" name="psgphone" id="psgphone" class="box_input" maxlength="15"  placeholder="กรุณาพิมพ์เบอร์โทรศัพท์ติดต่อ" maxlength="10" />
			</div>			

		            	<div ng-controller="PostsCtrl">
		              		<div class="wrapper b-b header">{{title}} : 
			                <a ng-click="pulltaxi(1);">ON</a>
			                || 
			                <a ng-click="pulltaxi(2);">OFF</a>
			                ||
			                <a ng-click="pulltaxi('');">ALL</a>
		              		</div>
		          	</div>

		             	<div >
				<div>
			                  <!--ul >
			                    <!li ng-repeat="post in postes" ng-click="pullbackTxPlate(post); h_classTx = !h_classTx;" id="{{ post.uid }}" value=" {{ post.uid }}" ng-class="{ 'myVar_true' : h_classTx == true , 'myVar_false' : h_classTx == false }" >{{ post.status }} -|- {{ post.carType }} : {{ post.carLicense }}  
			                    </li>
			                  </ul-->
		                	</div>
			</div>            

			<div class="menu-box-row">
				<button type="button" class="btn btn-large btn-block" onClick="gatMeaTaxi();" >เรียกแท๊กซี่</button>					
			</div>			
		</div>

 
		<div class="menu-dialog">
			<button type="button" class="btn btn-info btn-lg" id="but_checkstatus">สถานะ</button>
			<!--button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button-->	
		</div>


		<div class="process-loading-topic">			
			CALLING A TAXI
		</div>


		<div class="process-loading">			
			<img src="../img/loadingwaiting.gif">
		</div>
		

		<!-- Modal -->
		<div id="myModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Modal Header</h4>
					</div>
					<div class="modal-body">
						<p>Some text in the modal.</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>


	</body>





	<script>
		
	var socket ; 

	if(document.location.hostname=='localhost'){
		socket = io.connect(document.location.hostname+':1114');  	// for  localhost
	} else {
		socket = io.connect('/');						// for server
	} 

		var map = H.map("map");
		var drawControl = new L.Control.Draw();

		var marker;
		var nLayer;
		var kml;
		var fires24;
		var toggleState = true;
		var jsonPoiList = 0;

		var CStartingP;
		var CEndingP;
		var CStartingPlat;
		var CStartingPlng;
		var CEndingPlat;
		var CEndingPlng;

		var OSEPolyline;
		var SEPolyline;

		var markerS;
		var markerD;
		var putTaxi;		
		var putPsg;
		var putDrv;
		var tempmk;
		var AllDrvMarker;
		var DrvLocMarker;

		var PsgLayer = {};
		var TaxiCurLayer = {};
		var PsgCurLayer = {};

		var animatedMarker;
		var polyline_123;

		var tempid;		
		var curlng = 104.8601933 ;
		var curlat = 15.243196;
		var tmppsgstatus;

		var flag = true ;  // to check dialog
			
		//tempid = "xxx";
		tempid = localStorage.getItem('device_id');
		map.setView([13.753,100.571], 10);
		map.control.menu.disable();
		map.control.rightclick.disable();

		map.on('draw:created', function (e) {
			var type = e.layerType,
			layer = e.layer;
			map.addLayer(layer);
		});

		$(function(){
			//alert(tempid);
			//setInterval(function() { 			
		
			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
				      	//console.log('lat =>'+position.coords.latitude+' || lon =>'+position.coords.longitude);
				      	curlng =  position.coords.longitude ;
				      	curlat =  position.coords.latitude ;				      
				      	//JsonData = { "type": "Point", "coordinates": [position.coords.longitude, position.coords.latitude], "lat": position.coords.latitude, "lng": position.coords.longitude, "time stamp" : [new Date(position.timestamp)], "tempid" : tempid }
				      	//console.log(JsonData)
				      	//socket.emit('myPsgLocation',  JsonData );
				      	getDrvarround( curlng, curlat,   1000000,50);				      	
				      	checkstatuspsg();
				}, function() {
					console.log("Can not get your location !!");
				});
			}
		
			//},	5000);
			checkCenter(function(  ){				
				//getDrvarround(  10000,100);
			});			
			// socket.on('news', function (data) {
			//     console.log(data);
			//     socket.emit('my other event', { my: 'data' });
			// });
			
  
   
   
   	setInterval(function() { 			
		   getDrvarround( curlng, curlat,   1000000,500);	  
	},	10000);
	

			setInterval(			
				checkstatuspsg
               			
			,10000);
			


			
			// click to check status + show dialog
			$('#but_checkstatus').click(function(){
				flag = true;
				checkstatuspsg();
			})




			$('#psgfrom').keydown(function () {
				// Allow special chars + arrows                 
				if ($(this).val() != '') { /* do stuff here */
					$(this).removeClass('error');
				} else {
					$(this).addClass('error');
				}
			});

			
			$('#psgto').keydown(function () {
				// Allow special chars + arrows                 
				if ($(this).val() != '') { /* do stuff here */
					$(this).removeClass('error');
				} else {
					$(this).addClass('error');
				}
			});


			$('#psgphone').keydown(function (event) {
				// Allow special chars + arrows                                 
				if ($(this).val().length < 8) { /* do stuff here */
					$(this).addClass('error');
				} else {
					$(this).removeClass('error');
				}
				if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9
				|| event.keyCode == 27 || event.keyCode == 13
				|| (event.keyCode == 65 && event.ctrlKey === true)
				|| (event.keyCode >= 35 && event.keyCode <= 39)) {
				return;
				} else {
					// If it's not a number stop the keypress
					if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105)) {
						event.preventDefault();
					}
				}
			});


		});
		


		function checkCenter(callback){
			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
			      		//console.log('lat =>'+position.coords.latitude+' || lon =>'+position.coords.longitude);
			      		curlng =  position.coords.longitude ;
			      		curlat =  position.coords.latitude ;
			      		JsonData = { "type": "Point", "coordinates": [position.coords.longitude, position.coords.latitude], "lat": position.coords.latitude, "lng": position.coords.longitude, "time stamp" : [new Date(position.timestamp)], "tempid" : tempid }
			      		//console.log(JsonData)
			      		//socket.emit('myPsgLocation',  JsonData );
			      		addPoiJson(JsonData);
			      		//callback();			      
			    		}, function() {
			      			console.log("Can not get your location, please allow browser to get your location.");
		    		});
			}			
			//getAllPassenger();			
		}



		
		
		function checkstatuspsg() { 
			//console.log('checkstatuspsg')
			//console.log('curlng ='+curlng)			
			if (curlng != 0) {
				$.ajax({
					type: "POST",
					contentType: "application/json; charset=utf-8", 				     
					url : "../service/passengercs/getStatus",
					dataType: "json", 
					data: " { \"device_id\": \""+tempid+"\", \"curlng\": "+curlng+", \"curlat\": "+curlat+" } ", 			     
					success: function(data){
			        		//console.log(data.data.status);
			        		var getstatus = data.data.status;
			        		if (data.data.drv_id){
			        			getDrvLoc(data.data.drv_id);	
			        		}					
					switch(getstatus) {
						case "OFF":							
							if (tmppsgstatus != "OFF" ) {
								tmppsgstatus = "OFF"; 	
								BootstrapDialog.closeAll()
								flag = false;
							}							
							$(".menu-box").show();
							$(".process-loading-topic").hide();
							$(".process-loading").hide();						
							console.log(data.data.status);
							console.log(data.data.drv_id);
						break;
						
						case "ON":
							if (tmppsgstatus != "ON" ) {
								tmppsgstatus = "ON"; 	
								BootstrapDialog.closeAll()
								flag = true;
							}
							$(".menu-box").hide();
							//$(".process-loading-topic").hide();
							//$(".process-loading").show();		
							if  ( flag ) {
								flag= false  ;		
								var text =  'รอสักครู่ เรากำลังดำเนินการ<br>' ;	
								text += '<img src="../img/loadingwaiting.gif"><br>';
								
							        	BootstrapDialog.show({
							            		title: 'กำลังเรียกแท็กซี่',
							            		message:  text,
							            		buttons: [{
							                		label: 'ยกเลิก',
							                		cssClass: 'btn-warning',
							                		action: function(dialogItself) {
											$.ajax({
												type: "POST",
												contentType: "application/json; charset=utf-8", 				     
												url : "../service/passengercs/cancelCall",
												dataType: "json", 
												data: " { \"device_id\": \""+tempid+"\", \"curlng\": "+curlng+", \"curlat\": "+curlat+" } ", 			     
												success: function(data){									     
												} 
											});
											dialogItself.close();
											$(".menu-box").show();
							            			}
							            		}]
							       	 });
							}								
							//$('#myModal').modal('show');
							console.log(data.data.status);
							console.log(data.data.drv_id);	
						break;

						case "WAIT":
							$(".menu-box").hide();
							//$(".process-loading-topic").hide();
							//$(".process-loading").show();							
							console.log(flag)
							if (tmppsgstatus != "WAIT" ) {
								tmppsgstatus = "WAIT"; 	
								BootstrapDialog.closeAll()
								flag = true;
							}
							if  (  flag    ) {
								flag= false  ;
								$.ajax({
									type: "POST",
									contentType: "application/json; charset=utf-8", 				     
									url : "../service/drivercs/getByID",
									dataType: "json", 
									data: " { \"_id\": \""+data.data.drv_id+"\" } ", 			     
									success: function(result){
										var  text = 'This taxi has chose you,<br>'  ;
										text += 'ชื่อ : '+ result.data.fname + ' ' + result.data.lname +'<br>';
										text += 'ทะเบียน : '+ result.data.carplate  +'<br>';
										text += 'เบอร์ติดต่อ : <a href="tel:'+result.data.phone+'" >'+ result.data.phone  +'</a><br>';	
										//var hosttemp = document.location.hostname;
										var hosttemp = 'http://ecvttaxiapp1.ecartstudio.com';
										if (result.data.imgface!='') {
										text += '<img src="'+hosttemp+'/image/driver/'+ result.data.imgface  +'" width="150" ><br>';	
										}

										text += '<br>please select to accept or cancel'  ;
																				
										BootstrapDialog.show({
											title: '<h3>You got  a taxi</h3>',
											message:  text  ,
											buttons: [{
												label: 'Accept this Taxi',
												cssClass: 'btn-primary',
												action: function(dialogItself) { 
													flag= true  ;
													$.ajax({
														type: "POST",
														contentType: "application/json; charset=utf-8", 				     
														url : "../service/passengercs/acceptDrv",
														dataType: "json", 
														data: " { \"device_id\": \""+tempid+"\" , \"drv_id\":\""+data.data.drv_id+"\" } ", 			     
														success: function(result){
														}
													});	
													dialogItself.close();
												}
											} , {
												label: 'Cancel this Taxi',
												cssClass: 'btn-warning',
												action: function(dialogItself) {
													flag= true  ;
													$.ajax({
														type: "POST",
														contentType: "application/json; charset=utf-8", 				     
														url : "../service/passengercs/cancelDrv",
														dataType: "json", 
														data: " { \"device_id\": \""+tempid+"\" , \"drv_id\":\""+data.data.drv_id+"\" } ", 			     
														success: function(result){
														}
													});
													dialogItself.close();
												}
											}]
										});
									} 
								});
							}
							//$('#myModal').modal('show');							
							console.log(data.data.status);	
							console.log(data.data.drv_id);							
						break;	

						case "BUSY":
							if (tmppsgstatus != "BUSY" ) {
								tmppsgstatus = "BUSY"; 	
								BootstrapDialog.closeAll()
								flag = true;
							}						
							$(".menu-box").hide();
							//$(".process-loading-topic").hide();
							//$(".process-loading").show();							
							if  ( flag ) {
								flag= false  ;
								$.ajax({
									type: "POST",
									contentType: "application/json; charset=utf-8", 				     
									url : "../service/drivercs/getByID",
									dataType: "json", 
									data: " { \"_id\": \""+data.data.drv_id+"\" } ", 			     
									success: function(result){
										var  text = 'He will be get to you soon.<br>'  ;		
										text += '<img src="../img/taxi_going_1.gif"><br>';
										text += 'ชื่อ : '+ result.data.fname + ' ' + result.data.lname +'<br>';
										text += 'ทะเบียน : '+ result.data.carplate  +'<br>';
										text += 'เบอร์ติดต่อ : <a href="tel:'+result.data.phone+'" >'+ result.data.phone  +'</a><br>';
										//var hosttemp = document.location.hostname;
										var hosttemp = 'http://ecvttaxiapp1.ecartstudio.com';
										if (result.data.imgface!='') {
										text += '<img src="'+hosttemp+'/image/driver/'+ result.data.imgface  +'" width="150" ><br>';	
										}											
										BootstrapDialog.closeAll()
										BootstrapDialog.show({
											title: '<h3>Please wait </h3>',
											message:  text  ,
											
											buttons: [{
												label: 'Hide dialog',
												action: function(dialogItself) { 
													dialogItself.close();					
												}
											} , {
											
												label: 'Cancel this Taxi',
												cssClass: 'btn-warning',
												action: function(dialogItself) {
													//flag= true  ;
													$.ajax({
														type: "POST",
														contentType: "application/json; charset=utf-8", 				     
														url : "../service/passengercs/cancelCall",
														dataType: "json", 
														data: " { \"device_id\": \""+tempid+"\" , \"drv_id\":\""+data.data.drv_id+"\" } ", 			     
														success: function(result){
														}
													});
													dialogItself.close();
												}
											}]
										});
									} 
								});
							}
							//$('#myModal').modal('show');
							console.log(data.data.status);
							console.log(data.data.drv_id);								
						break;

						case "PICK":
							if (tmppsgstatus != "PICK" ) {
								tmppsgstatus = "PICK"; 	
								BootstrapDialog.closeAll()
								flag = true;
							}						
							$(".menu-box").hide();
							//$(".process-loading-topic").hide();
							//$(".process-loading").show();							
							if  ( flag ) {
								flag= false  ;
								$.ajax({
									type: "POST",
									contentType: "application/json; charset=utf-8", 				     
									url : "../service/drivercs/getByID",
									dataType: "json", 
									data: " { \"_id\": \""+data.data.drv_id+"\" } ", 			     
									success: function(result){
										var  text = 'Your driver info: <br>'  ;
										text += 'ชื่อ : '+ result.data.fname + ' ' + result.data.lname +'<br>';
										text += 'ทะเบียน : '+ result.data.carplate  +'<br>';
										text += 'เบอร์ติดต่อ : <a href="tel:'+result.data.phone+'" >'+ result.data.phone  +'</a><br>';
										//var hosttemp = document.location.hostname;
										var hosttemp = 'http://ecvttaxiapp1.ecartstudio.com';
										if (result.data.imgface!='') {
										text += '<img src="'+hosttemp+'/image/driver/'+ result.data.imgface  +'" width="150" ><br>';
										}
										BootstrapDialog.closeAll()
										BootstrapDialog.show({
											title: '<h3>Your driver is with you.</h3>',
											message:  text ,
											buttons: [{
												label: 'Hide this dialog',
											    	action: function(dialogRef){
											        		dialogRef.close();
											    	}
											}]
										});
									} 
								});
							}
							//$('#myModal').modal('show');
							//console.log(data.data.status);
							//console.log(data.data.drv_id);								
						break;

						default:
							//default code block
						}				        	
			     		} // switch
				});					
			} // undefined curlat
		}




		/*
		$(function() {  	
			$("#psgnearby").autocomplete({ 
			    source: function (request, response) { 
			        $.ajax({ 
			            type: "POST", 
			            contentType: "application/json; charset=utf-8", 
			            url: "http://locator-dev.ecartmap.com/locator/poi", 
			            dataType: "json", 
			            data: "{'Name':'" + request.term + "'}", 
			            success: function (data) { 
			            	//console.log(data)
			           		response($.map(data, function (item) {                			
			            	    return { 
			                	    //label: item.Name + '(' + item.Value + ')',
			                        label: item.Name, value: item.Name, latlng: item.Lat+','+item.Long
			                        } 
			                    }	//return
			                    )	//(data
			           		)		//$.map
			            } 
			        }); 
			    }, 
			    minLength: 2, 
			    select: function (event, ui) {      		
			  		var setlatlng = ui.item.latlng; 
			  		//alert(setlatlng);
			  		//map.setView([.split','],15);
			  		map.setView(setlatlng.split(','),13)
			  		PinDestination();
			    }, 
			    open: function () { 
			        $(this).removeClass("ui-corner-all").addClass("ui-corner-top"); 
			    }, 
			    close: function () { 
			        $(this).removeClass("ui-corner-top").addClass("ui-corner-all"); 
			    }, 
			    error: function (XMLHttpRequest, textStatus, errorThrown) { 
			        alert(textStatus); 
			    } 
			}); 
		});	
		*/
	
	
		function checkGPS(callback){			
			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					//console.log('lat =>'+position.coords.latitude+' || lon =>'+position.coords.longitude);
					curlng =  position.coords.longitude ;
					curlat =  position.coords.latitude ;
					JsonData = { "type": "Point", "coordinates": [position.coords.longitude, position.coords.latitude], "lat": position.coords.latitude, "lng": position.coords.longitude, "time stamp" : [new Date(position.timestamp)], "tempid" : tempid }
					//console.log(JsonData)
					//socket.emit('myPsgLocation',  JsonData );
			      		//addPoiJson(JsonData);
					//callback();
					//getDrvarround( curlng, curlat,   10000,100);
			    	}, function() {
			      		console.log("Can not get your location, please allow browser to get your location.");
			    	});
			}			
			//getAllPassenger();			
		}



		function addPoiJson(JsonData) {
			//var myIcon = L.icon({iconUrl: 'img/map/taxi_pin.png'});
			var myIcon = L.icon({			 	
			 	iconUrl: '../assets/img/map/pin-passenger.png',
			 	//shadowUrl: 'img/map/leaf-shadow.png'
				iconAnchor: [25, 25]			 	
			 });
			 var myStyle = {
			 	color: '#f00',
			 	fillColor: '#ffc4c4',
			 	weight: 2,
			 	opacity: 0.8,
			 	icon: myIcon,			
			 	iconUrl: 'img/map/pin-passenger.png'
			 };
			 /*
			jsonPoiList = L.geoJson(JsonData, {
			   	style: myStyle
			 });
			 */
			//console.log(map.getCenter())			
			if(map.hasLayer(putPsg)) {
				map.removeLayer(putPsg);
			} else {
				map.setView([JsonData.coordinates[1],JsonData.coordinates[0]],15);
				//PinStart();
			}			
			putPsg = new L.marker([JsonData.coordinates[1],JsonData.coordinates[0]], {icon: myIcon, style: myStyle}).whitePopup('<b>พิกัด '+ JsonData.coordinates[1] +' , '+ JsonData.coordinates[0]);			
			map.addLayer(putPsg);
			//console.log(JsonData.getBounds())
			//map.fitBounds(JsonData.getBounds());
			//console.log(typeof )	
		}



		function addPoi(JsonData) {
		//console.log('add poi');		 
		 var myIcon = L.icon({iconUrl: 'img/map/taxi_pin.png'});
		 
		 var myStyle = {
		 	color: '#f00',
		 	fillColor: '#ffc4c4',
		 	weight: 2,
		 	opacity: 0.8,
		 	icon: myIcon,			
		 	iconUrl: 'img/map/taxi_pin.png'
		 };
			
			console.log('hey!!!!!!');
			$.each(JsonData.data, function(i, item) {
			  //console.log(item.lat +' , '+item.lng) ;			  
			 	putMarker = new L.marker([item.lat,item.lng], {icon: myIcon, style: myStyle});
				map.addLayer(putMarker);			  
			});

		}



		/* -----------------------------------------
				Get passenger list (all)
	  	   ----------------------------------------- */

		function getAllPassenger () {

			//console.log('getAllPassenger');
			// $.ajax({
			//     url : "/service/getPassenger/all",
			//     type: "GET",
			//     success: function(data){
			//        	console.log(data);
			//        	addPoiJson(data.geoJson);
			//     }
			// });

			socket.emit('PsgCurLatLng',{msg:'request'});

			socket.on('show all passenger',function(data){
				//alert('her its html show all passenger !!');
				//console.log(data);
				addPoi(data);
			});
		}





		function getDrvarround(curlng, curlat, radian, limits){		
			$.ajax({
				type: "POST",
			     	contentType: "application/json; charset=utf-8", 				
				url : "../service/passengercs/searchDrv",
				dataType: "json", 
				data: " { \"curlng\": "+curlng+", \"curlat\": "+curlat+", \"radian\":1000000, \"amount\":100 } ", 			     
			     	success: function(data){			        		
			        		addPoiTaxi(data);
			     	} 
			 });
		}



		function getDrvLoc(drv_id){			
			 $.ajax({
			     type: "POST",
			     contentType: "application/json; charset=utf-8", 			     
			     url : "../service/passengercs/getDrvLoc",
			      dataType: "json", 
			      data: " { \"device_id\": \""+tempid+"\", \"drv_id\": \""+drv_id+"\" } ", 			     
			     success: function(data){			        				        	
			        	if(TaxiCurLayer) { 			        		
					/*
					for (var i in TaxiCurLayer) {
					  console.log(i)
					}
					*/
					$.each(TaxiCurLayer, function(i) {						
						if(map.hasLayer(TaxiCurLayer[i])){
							map.removeLayer(TaxiCurLayer[i]);							
						} else {
							//map.setView([JsonData.coordinates[1],JsonData.coordinates[0]],15);
						}						
					});
					TaxiCurLayer = '';			        		
			        	} else {
			        		//console.log('no layer object')
			        		if(map.hasLayer(DrvLocMarker)) {
			        			map.removeLayer(DrvLocMarker);
			        			addPoiDrvLoc(data);	
			        		} else {
			        			addPoiDrvLoc(data);	
			        		}
			        		
			        	}
				
				/*
				if(map.hasLayer(putDrv)) {
					map.removeLayer(putDrv);
				} else {
					console.log('putDrv')
				}	
				*/		        	
			        	//addPoiTaxi(data);
			     } 
			 });
		}




		/* -----------------------------------------
				Get passenger by ID
	  	   ----------------------------------------- */
		function getPassengerById () {
			var data = {
				uid: '555',
				name: 'สมหมาย',
				carLicense: 'ดก-4448',
				lat: 13.3, 
				lng: 100.1,
				distance: 200,
				detail: '',
				status: 3
			};
			$.ajax({
			    url : "/service/getPassenger/5555",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			    }
			});
		}





		/* -----------------------------------------
				Get passenger
	  	   ----------------------------------------- */
		function updatePassenger () {
			var data = {
				uid: '555',
				registrationId: 'sdfadsgjakfdg',
				name: 'สมหมาย',
				carLicense: 'ดก-4448',
				lat: 13.33333333, 
				lng: 100.11243256,
				distance: 200,
				detail: '',
				passengerID: '',
				status: 1
			};
			$.ajax({
			    url : "/service/getPassenger",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			    }
			});
		}


		/* -----------------------------------------
			POST Taxi need to cancel passenger 
	  	   ----------------------------------------- */
	  	   function updateDevice () {
			var data = {
				uid: '555',
				name: 'สมหมาย',
				carLicense: 'ดก-4448',
				lat: 13.456, 
				lng: 100.11243256,
				distance: 4564,
				detail: '',
				passengerID: '0001',
				status: 1
			};
			$.ajax({
			    url : "service/device/updateStatus",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			    }
			});
		}


		/* -----------------------------------------
			POST Taxi need to picup passenger
	  	   ----------------------------------------- */
		function updateDeviceWaiting () {
			var data = {
				uid: '555',
				name: 'สมหมาย',
				carLicense: 'ดก-4448',
				lat: 13.456, 
				lng: 100.11243256,
				distance: 4564,
				detail: '',
				passengerID: '0001',
				status: 5
			};
			$.ajax({
			    url : "service/device/updateStatus",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			    }
			});
		}




		/* -----------------------------------------
				Get Taxi
	  	   ----------------------------------------- */

		function getTaxi () {

			var data = {
				uid: '5555',
				registrationId: 'ljfglkdf',
				name: 'สมบัติ',
				phoneNumber: '0843112347',
				lat: 13.0, 
				lng: 100.9,
				distance: 200,
				detail: '',
				destination: 'กรุงเทพ',
				status: 1
			};

			$.ajax({
			    url : "/service/getDevice",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			    }
			});

		}





		/* -----------------------------------------
				Get Taxi list (all)
	  	----------------------------------------- */
		function getAllTaxi () {
			$.ajax({
			    url : "/service/getDevice/all",
			    type: "GET",
			    success: function(data){
			       	//console.log(data)
			    }
			});

		}



		socket.on('ShowTaxiLocation', function (data) {	  	    
		    //console.log(data);
		    addPoiTaxi(data);
		});
 
 
		var test = ''

		function addPoiTaxi(JsonData) {			
		 
			 var  myIcon  ; 
			 var myStyle = {
			 	color: '#f00',
			 	fillColor: '#ffc4c4',
			 	weight: 1,
			 	opacity: 0.8,
			 	icon: myIcon,			
			 	iconUrl: 'img/map/taxi_pin.png'
			 };
			 
			 
				//console.log('hey!!!!!! น้องไอยรา ... ');
				test = JsonData;



				$.each(JsonData.data, function(i, item) {
					 tempmk = item._id;
					/* 		  
				 	AllDrvMarker = new L.marker([item.curlat,item.curlng], {icon: myIcon, style: myStyle}).bindPopup( '<b>ชื่อ</b>:'+item.fname+' '+item.lname+'<br><b>โทรศัพท์</b>: <a href="tel:'+item.phone+'">'+item.phone+'</a><br><b>ทะเบียน</b>: '+item.carplate+'<br>' ) ;
					map.addLayer(AllDrvMarker);
					*/ 
		        		if(map.hasLayer(TaxiCurLayer[tempmk]) ) {
		        			map.removeLayer(TaxiCurLayer[tempmk]);		        			
		        		} 
						 
				
					
						myIcon = L.icon({			 	
							iconUrl: '../assets/img/map/pin-taxi-'+item.status+'.png',
							//shadowUrl: 'img/map/leaf-shadow.png'
							iconAnchor: [20, 20] ,
                            labelAnchor:[10,0] 								
						 });
				    var tlabel =  item.carplate ; 
				 	TaxiCurLayer[tempmk]  = new L.marker([item.curlat,item.curlng], {icon: myIcon, style: myStyle}).bindLabel( tlabel ,{ noHide:true } ).bindPopup( '<b>ชื่อ</b>:'+item.fname+' '+item.lname+'</a><br><b>ทะเบียน </b> : '+item.carplate+'<br>'+'<br><b> โทรศัพท์ </b> : <a href="tel:'+item.phone+'">'+item.phone  ) ;
					
					
					map.addLayer( TaxiCurLayer[tempmk]);		  
					
				});
		}



		function addPoiDrvLoc(JsonData) {			
			var myIcon = L.icon({			 	
			 	iconUrl: '../assets/img/map/pin-taxi-40.png',
			 	//shadowUrl: 'img/map/leaf-shadow.png'
				iconAnchor: [20, 20]			 	
			 });		 
			 var myStyle = {
			 	color: '#f00',
			 	fillColor: '#ffc4c4',
			 	weight: 2,
			 	opacity: 0.8,
			 	icon: myIcon,			
			 	iconUrl: 'img/map/taxi_pin.png'
			 };
				//console.log('hey!!!!!! น้องไอยรา ... ');
				//test = JsonData;
			 	DrvLocMarker = new L.marker([JsonData.data.curlat,JsonData.data.curlng], {icon: myIcon, style: myStyle}).bindPopup( '<b>ชื่อ</b>:'+JsonData.data.fname+' '+JsonData.data.lname+'<br><b>โทรศัพท์</b>: <a href="tel:'+JsonData.data.phone+'">'+JsonData.data.phone+'</a><br><b>ทะเบียน</b>: '+JsonData.data.carplate+'<br>' ) ;
				map.addLayer(DrvLocMarker);
		}



	function PinStart(){
		var myIcon = L.icon({
			iconUrl: 'img/map/pin-passenger.png',
			iconAnchor: [25, 25],		    
		});
		var pinCenter = map.getCenter();			
		markerS = L.marker(pinCenter,{icon: myIcon, draggable: true });			
		markerS.bindLabel('Start', {noHide: true});
		markerS.addTo(map);
		map.setView(pinCenter,15);
		//markerS.dragging.enable();
		markerS.on('dragend', function(e) {			    
		    //CStartingP = markerS.getLatLng();
			CStartingPlat = markerS.getLatLng().lat;
		    	CStartingPlng = markerS.getLatLng().lng;			    
			//markerS.bindPopup('<p>Please confirm the starting point<br><center><input type="button" value="START"></center></p>').openPopup();
			$.ajax({
				url : "http://proxy.hmap-dev.ecartmap.com/getDirection.php?url=https%3A//maps.googleapis.com/maps/api/directions/json%3Forigin%3D"+CStartingPlat+"%2C"+CStartingPlng+"%26destination%3D"+CEndingPlat+"%2C"+CEndingPlng+"%26waypoints%3Doptimize%3Atrue%26mode%3Ddriving%26language%3DTH%26sensor%3Dfalse%26key%3DZNViRo_sRGCtsSc3BeC280Rlprg%3D%26client%3Dgme-ecartstudiocompany&dummy=0.5774756167083979%20200%20OK%201417ms",
				type: "GET",
				success: function(data){
			    		if (data.status=='OK') {
			    			var enc = data.routes[0].overview_polyline.points;
			    			var straddr = data.routes[0].legs[0].start_address;
			    			var endaddr = data.routes[0].legs[0].end_address;
			    			var tim = data.routes[0].legs[0].duration.text;
			    			var dis = data.routes[0].legs[0].distance.text;
			    			$('#FromDir').text(straddr);
			    			$('#ToDir').text(endaddr);
			    			$('#DistanceDir').text(dis);
			    			$('#TimeDir').text(tim);
			    			var polyDecode = map.navigation._decodeGoogle(enc);
			    			//console.log(polyDecode)
			    			if (OSEPolyline!=undefined) {				    		
			    				map.removeLayer(OSEPolyline);
			    				OSEPolyline = L.polyline(polyDecode).addTo(map);
			    			} else {
			    				OSEPolyline = L.polyline(polyDecode).addTo(map);
			    			}
			       			//console.log(data);
			       			$("#idirection").show();
			    		}
			    	}
			});

		});			
	}


	function PinDestination(){		
		var myIcon = L.icon({
		    iconUrl: 'img/map/pin-destination.png',		    
		    iconAnchor: [25, 25],		    
		});
		var pinCenter = map.getCenter();			
		markerD = L.marker(pinCenter, {icon: myIcon, draggable: true});
		markerD.bindLabel('Destination', {noHide: true});
		markerD.addTo(map);
		map.setView(pinCenter,15);
		//markerD.dragging.enable();
		markerD.on('dragend', function(e) {			    
		    //CEndingP = markerD.getLatLng();
			CEndingPlat = markerD.getLatLng().lat;
		CEndingPlng = markerD.getLatLng().lng;
			$.ajax({					
				url : "http://proxy.hmap-dev.ecartmap.com/getDirection.php?url=https%3A//maps.googleapis.com/maps/api/directions/json%3Forigin%3D"+CStartingPlat+"%2C"+CStartingPlng+"%26destination%3D"+CEndingPlat+"%2C"+CEndingPlng+"%26waypoints%3Doptimize%3Atrue%26mode%3Ddriving%26language%3DTH%26sensor%3Dfalse%26key%3DZNViRo_sRGCtsSc3BeC280Rlprg%3D%26client%3Dgme-ecartstudiocompany&dummy=0.5774756167083979%20200%20OK%201417ms",
			    	type: "GET",
			    	success: function(data){
			    		var enc = data.routes[0].overview_polyline.points;
			    		var straddr = data.routes[0].legs[0].start_address;
			    		var endaddr = data.routes[0].legs[0].end_address;
			    		var tim = data.routes[0].legs[0].duration.text;
			    		var dis = data.routes[0].legs[0].distance.text;
			    		$('#FromDir').text(straddr);
			    		$('#ToDir').text(endaddr);
			    		$('#DistanceDir').text(dis);
			    		$('#TimeDir').text(tim);				    	
			    			var polyDecode = map.navigation._decodeGoogle(enc);				    	
			    			//console.log(polyDecode)
			    	if (OSEPolyline!=undefined) {				    		
			    		map.removeLayer(OSEPolyline);
			    		OSEPolyline = L.polyline(polyDecode).addTo(map);
			    	} else {
			    		OSEPolyline = L.polyline(polyDecode).addTo(map);
			    	}
			    	$("#idirection").show();
			    	//console.log(dis);
			    	//console.log(tim);
			       	//console.log(data);
			       	//map.clearLayer();
			    }
			});
		    //markerD.bindPopup('<p>Please confirm the destination point<br><center><input type="button" value="DESTINATION"></center></p>').openPopup();
		});			
	}






	function gatMeaTaxi () {
		//alert('getmeataxi')
		if ( $('#psgfrom').val()==''  || $('#psgto').val()=='' || $('#psgphone').val()==''  ){
			alert('กรุณากรอกข้อมูลให้ครบถ้วน')
		} else {
			var data = {
				device_id: tempid,
				curaddr: $('#psgfrom').val(),
				destination: $('#psgto').val(),
				phone: $('#psgphone').val(),			
				curlng: curlng,
				curlat: curlat,
				tip: 0,
				detail: ''
			};

			$.ajax({
			    url : "../service/passengercs/callDrv",
			    type: "POST",
			    data : data,
			    success: function(data){
			       	//console.log(data)
			       	checkstatuspsg();
				/*if  ( flag ) {
					flag= false  ;		
					var text =  'please wait for taxi to get the queue<br>' ;								
					text += '<img src="../img/taxi_going_1.gif"><br>';
					text += '<img src="../img/loadingwaiting.gif"><br>';
				        	BootstrapDialog.show({
				            		title: '<h1>Calling a taxi</h1>',
				            		message:  text,
				            		buttons: [{
				                		label: 'Cancel',
				                		cssClass: 'btn-warning',
				                		action: function(dialogItself) {
								$.ajax({ 
									type: "POST",
									contentType: "application/json; charset=utf-8", 				     
									url : "../service/passengercs/cancelCall",
									dataType: "json", 
									data: " { \"device_id\": \""+tempid+"\", \"curlng\": "+curlng+", \"curlat\": "+curlat+" } ", 			     
									success: function(data){									     
						 			} 
								});
								dialogItself.close();
								$(".menu-box").show();
				            			}
				            		}]
				       	 });
				}*/
			    }
			});
		}
	}

	</script>
</html>