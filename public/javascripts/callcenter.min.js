var Map=null,LOCAL_DATA={},LOCAL_CACHE={},App={init:function(){App.show(),Preloader.show(),Sound.initial(),Socket.initial(),App.createMap(),Taxi.initial(),Loader.initial(),HotKey.initial(),LandMark.initial(),Bootstrap.initial(),JQuery.NumberOnlyInit(),DateTimePicker.initial(),iOSwitchery.initial(),Monitoring.initial(),Form.createTaskForm.initial(),Form.assignTaskForm.initial(),Form.announceForm.initial(),Form.announceEditForm.initial(),Modal.initial(),Modal.reportModal.initial(),Modal.successModal.initial(),Modal.createTaskModal.initial(),Modal.assignTaskModal.initial(),Modal.assignedTaskModal.initial(),Modal.announcementModal.initial(),Modal.assignTaskByLineModal.initial(),Modal.announcementEditModal.initial(),Modal.confirmNoneRegisterDriverModal.initial()},show:function(){setTimeout(function(){$(".intial-app-loading").find(".loader, .text").fadeOut("fast"),setTimeout(function(){$(".intial-app-loading").fadeOut("normal"),setTimeout(function(){$("body > .container-fluid.app").fadeIn(700),$("body > .navbar").fadeIn(700),setTimeout(function(){DataTable.queueTaskTable.initial(),DataTable.taxiReportTable.initial(),DataTable.advanceTaskTable.initial(),DataTable.pendingTaskTable.initial(),DataTable.assignedTaskTable.initial()},700),setTimeout(function(){$("body").removeClass("loading"),$(".intial-app-loading").remove()},700)},700)},700)},1e3)},createMap:function(){Map=H.map("map"),Map.setBasemap(3),Map.toggle3D(),Map.setMaxZoom(18),Map.setLanguage("TH"),Map.control.locate.disable()},setDefaultPosition:function(){Map.setView(USER_CURRENT_LOCATION,12)},setCurrentPosition:function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){Map.setView([a.coords.latitude,a.coords.longitude],13)})},toggleSidebar:function(){$("#st-container").toggleClass("st-menu-open"),$(".hb-locator_search").toggleClass("relative-sidebar")},hideSidebar:function(){$("#st-container").removeClass("st-menu-open"),$(".hb-locator_search").removeClass("relative-sidebar")},intervalManager:function(a,e,t){return a?setInterval(e,t):void("undefined"!=typeof e&&clearInterval(e))}},Announcement={getAll:function(){Http.post("service/ubeam/announcement/all",{onSuccess:function(a){a.status?(Modal.announcementModal.modal.find(".modal-body").empty(),$(a.data).each(function(a,e){var t='<div class="media" data-ref="'+e._id+'">';t+='<div class="media-left">',t+='<a href="#">',t+='<img class="media-object img-circle" src="assets/img/callcenter-profile-sample-face.png" style="width: 64px; height: 64px;">',t+="</a>",t+="</div>",t+='<div class="media-body">',t+='<h4 class="media-heading">'+e.topic+"</h4>",t+=e.detail,e.createdby===USER_DATA.username&&(t+='<a href="#" class="btn btn-link" onclick="Announcement.showEditModal(this);"><span class="glyphicon glyphicon-pencil edit" aria-hidden="true"></span> แก้ไบ</a>',t+='<a href="#" class="btn btn-link" onclick="Announcement.showConfirmRemoveModal(\''+e._id+'\');"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span> ลบทิ้ง</a>'),t+="</div>",t+="</div>",Modal.announcementModal.modal.find(".modal-body").append(t),Modal.announcementModal.modal.find(".modal-body [data-ref='"+e._id+"']").data(e)})):Modal.announcementModal.modal.find(".modal-body").empty()}})},remove:function(a){Preloader.show(),Http.post("/service/ubeam/announcement/delete",{data:{user_id:USER_DATA._id,ann_id:a},onSuccess:function(e){e.status?(Notification.defaultSuccess(),Modal.announcementModal.modal.find(".modal-body [data-ref='"+a+"']").remove(),Modal.confirmModal.modal.modal("hide")):Notification.defaultError()}})},showEditModal:function(a){var e=$(a).closest(".media").data();Modal.announcementEditModal.modal.find('[name="ann_id"]').val(e._id),Modal.announcementEditModal.modal.find('[name="topic"]').val(e.topic),Modal.announcementEditModal.modal.find('[name="detail"]').val(e.detail),Modal.announcementEditModal.open()},showConfirmRemoveModal:function(a){Modal.confirmModal.modal.on("shown.bs.modal",function(e){$(this).find('[data-dismiss="modal"]').focus(),$(this).find(".confirm").on("click",function(){window.Announcement.remove(a)})}),Modal.confirmModal.modal.on("hidden.bs.modal",function(a){$(this).find(".confirm").unbind("click"),$(this).unbind("shown.bs.modal"),$(this).unbind("hidden.bs.modal")}),Modal.confirmModal.modal.find(".modal-body > .message").html("ต้องลบประกาศนี้ใช่มั้ย?"),Modal.confirmModal.open()}},Bootstrap={initial:function(){$(".modal").modal({show:!1,keyboard:!0}),$('[data-toggle="tooltip"]').tooltip({animation:!1}),$(".user-profile-tab .dropdown-menu li:first").on("click",function(a){a.stopPropagation()}),$('#queueAdvanceTab a[data-toggle="tab"]').on("shown.bs.tab",function(a){"#table-queue-tab"==a.target.hash?DataTable.queueTaskTable.datatable.draw():"#table-advance-tab"==a.target.hash&&DataTable.advanceTaskTable.datatable.draw()}),$('#pendingAssignedTab a[data-toggle="tab"]').on("shown.bs.tab",function(a){"#table-pending-tab"==a.target.hash?DataTable.pendingTaskTable.datatable.draw():"#table-assigned-tab"==a.target.hash&&DataTable.assignedTaskTable.datatable.draw()})}},Chat={$this:$("#chat-board"),$caller:$("#navbar .chat-tab"),open:function(){Chat.$this.addClass("open")},toggle:function(){Chat.$this.toggleClass("open")},close:function(){Chat.$this.removeClass("open")},popOut:function(){this.close(),Chat.$caller.hide(),setTimeout(function(){window.open(window.location.origin+"/chat_box","_blank","toolbar=yes, scrollbars=no, resizable=yes, top=100, left=500, width=400, height=760")},300)}},DateTimePicker={minHour:3,picker:$("#createdjob"),initial:function(){var a=(new Date).getTime()+60*DateTimePicker.minHour*60*1e3;DateTimePicker.picker.datetimepicker({inline:!0,format:"MM/dd/YYYY HH:mm",minDate:new Date(a)})},setMinDate:function(){var a=(new Date).getTime()+60*DateTimePicker.minHour*60*1e3;DateTimePicker.picker.data("DateTimePicker").minDate(new Date(a))}},DataTable={queueTaskTable:{$table:$("#queueTaskTable"),datatable:null,initial:function(){DataTable.queueTaskTable.datatable=DataTable.queueTaskTable.$table.DataTable({scrollY:window.screen.availHeight-300,scrollCollapse:!0,paging:!1,searching:!0,oLanguage:{sEmptyTable:"ไม่มีข้อมูลให้แสดงผล"},columnDefs:[{targets:0,width:"30px"},{targets:1,width:"30px",className:"jobtype",render:function(a,e,t){var n='<span class="circle-text default" data-toggle="tooltip" title="คิวงานปกติ">N</span>',i='<span class="task-type circle-text orange" data-toggle="tooltip" title="งานจองล่วงหน้า">A</span>';return void 0!=a&&"QUEUE"==a?n:i}},{targets:2,width:"50px",render:function(a,e,t){return void 0==a?"":Util.getCurrentTime(a.toLocaleUpperCase())}},{targets:[3,4,5],className:"inline-edit",createdCell:function(a,e,t,n,i){3==i?$(a).attr("data-field-name","curaddr"):4==i?$(a).attr("data-field-name","destination"):5==i&&$(a).attr("data-field-name","phone"),$(a).attr({title:"ดับเบิ้ลคลิ๊กเพื่อแก้ไข","data-toggle":"tooltip"}).on("dblclick",DataTable.inlineEditable)}},{targets:6,width:"60px",render:function(a,e,t){var n='<span class="status-time '+Util.getTimeStatus(a)+'">';n+='<i class="fa fa-bookmark"></i>';var i=void 0!=t[1]&&"QUEUE"==t[1]?Util.getDiffTime(t[6]):{time:"งานจอง",unit:"ล่วงหน้า"};return n+='<span class="detail">'+i.time+"<br><span>"+i.unit+"</span>",n+="</span>"}},{targets:7,width:"70px",render:function(a,e,t){var n='<div class="btn-group" role="group" aria-label="...">';return n+='<button type="button" class="btn btn-default showFindTaxi" data-toggle="tooltip" title="จ่ายงาน" onclick="DataTable.queueTaskTable.callTaxiModal(this);"><i class="fa fa-taxi"></i></button>',n+='<button type="button" class="btn btn-default removeCurrentPassenger" data-toggle="tooltip" title="ลบออก" onclick="Passenger.showConfirmRemoveModal(\''+a+'\');"><i class="fa fa-trash-o"></i></button>',n+="</div>"}}],createdRow:function(a,e,t){$(a).attr("data-ref",e[7]),$(a).find('[data-toggle="tooltip"]').tooltip({placement:"top",container:"body",animation:!1}).on("show.bs.tooltip",function(){$("body").find(".tooltip.in").remove()})},rowCallback:function(a,e,t){$(a).find(".showFindTaxi").data(e)},drawCallback:function(a){}}),DataTable.queueTaskTable.update(!1)},update:function(a){Http.post("service/ubeam/getinitiatelist",{loader:a,onSuccess:function(a){a.status?(DataTable.queueTaskTable.datatable.clear(),DataTable.queueTaskTable.create(a.data),DataTable.queueTaskTable.customTableHeader(),Socket.emit("update state")):(DataTable.queueTaskTable.datatable.clear().draw(!1),DataTable.queueTaskTable.setIndicator())}})},create:function(a){return void 0==a?!1:($(a).each(function(a,e){DataTable.queueTaskTable.datatable.row.add([a+1,e.jobtype,e.createdjob,e.curaddr,e.destination,e.phone,e.createdjob,e._id]).draw(!1)}),void DataTable.queueTaskTable.setIndicator())},addRow:function(a){if(void 0==a)return!1;var e=DataTable.queueTaskTable.datatable.rows()[0].length;DataTable.queueTaskTable.datatable.row.add([e+1,a.jobtype,a.createdjob,a.curaddr,a.destination,a.phone,a.createdjob,a._id]).draw(!1),DataTable.queueTaskTable.setIndicator()},updateRow:function(a){var e=DataTable.queueTaskTable.$table.find('[data-ref="'+a.psg_id+'"]'),t=DataTable.queueTaskTable.datatable.row(e).index(),n=DataTable.queueTaskTable.datatable.cell(t,0).data();DataTable.queueTaskTable.datatable.row(t).data([n,a.jobtype,a.createdjob,a.curaddr,a.destination,a.phone,a.createdjob,a.psg_id]).draw(!1)},updateTimeStatus:function(){null!=DataTable.queueTaskTable.datatable&&DataTable.queueTaskTable.$table.find("tr").each(function(a,e){if($(e).is("[data-ref]")){var t=DataTable.queueTaskTable.datatable.cell(e,6).render("type");$(e).find("td:eq(6)").html(t),DataTable.queueTaskTable.setIndicator()}})},customTableHeader:function(){$(".queues.table-data").find("#searchQueueInput").on("keyup",function(){DataTable.queueTaskTable.datatable.search(this.value).draw(!1)})},setIndicator:function(){var a=DataTable.queueTaskTable.$table.find(".status-time.new").size();a>0?$("#queueAdvanceTab").find('[aria-controls="table-queue-tab"]').find(".indicator").html(a).show():$("#queueAdvanceTab").find('[aria-controls="table-queue-tab"]').find(".indicator").hide()},callTaxiModal:function(a){var e=$(a).data();Passenger.getData(e[7],function(a){if(a.status){var e=a.psg_data;Modal.assignTaskModal.modal.find(".text.phone").html(e.phone),Modal.assignTaskModal.modal.find(".text.current").html(e.curaddr),Modal.assignTaskModal.modal.find(".text.destination").html(e.destination),void 0==e.detail||""==e.detail?Modal.assignTaskModal.modal.find(".text.detail").html("<i>-</i>"):Modal.assignTaskModal.modal.find(".text.detail").html(e.detail),Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1).val(""),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Modal.assignTaskModal.modal.find("#pass_id").val(e._id),Modal.assignTaskModal.modal.data({passengerData:e,table:"queueTaskTable"}),Socket.emit("assigning task",{id:e._id,table:"queueTaskTable",user:USER_DATA}),Modal.assignTaskModal.open()}else Notification.defaultError()})}},advanceTaskTable:{$table:$("#advanceTaskTable"),datatable:null,initial:function(){DataTable.advanceTaskTable.datatable=DataTable.advanceTaskTable.$table.DataTable({scrollY:window.screen.availHeight-250,scrollCollapse:!0,paging:!1,searching:!0,oLanguage:{sEmptyTable:"ไม่มีข้อมูลให้แสดงผล"},columnDefs:[{targets:0,width:"40px"},{targets:1,width:"50px",render:function(a,e,t){return(void 0==a?"":'<span class="time">'+Util.getCurrentTime(a)+' น.</span><br/><span class="date">'+Util.getFullDate(a))+"</span>"}},{targets:[2,3,4],className:"inline-edit",createdCell:function(a,e,t,n,i){2==i?$(a).attr("data-field-name","curaddr"):3==i?$(a).attr("data-field-name","destination"):4==i&&$(a).attr("data-field-name","phone"),$(a).attr({title:"ดับเบิ้ลคลิ๊กเพื่อแก้ไข","data-toggle":"tooltip"}).on("dblclick",DataTable.inlineEditable)}},{targets:5,width:"80px",render:function(a,e,t){var n='<div class="btn-group" role="group">';return n+='<button type="button" class="btn btn-default" data-toggle="tooltip" title="ลบออก" onclick="Passenger.showConfirmRemoveModal(\''+a+'\');"><i class="fa fa-trash-o"></i></button>',n+="</div>"}}],createdRow:function(a,e,t){$(a).attr("data-ref",e[5]),$(a).find('[data-toggle="tooltip"]').tooltip({placement:"top",container:"body",animation:!1}).on("show.bs.tooltip",function(){$("body").find(".tooltip.in").remove()})},drawCallback:function(a){}}),DataTable.advanceTaskTable.update(!1)},update:function(a){Http.post("service/ubeam/getadvancelist",{loader:a,onSuccess:function(a){a.status?(DataTable.advanceTaskTable.datatable.clear(),DataTable.advanceTaskTable.create(a.data),DataTable.advanceTaskTable.customTableHeader(),Socket.emit("update state")):DataTable.advanceTaskTable.datatable.clear().draw(!1)}})},create:function(a){return void 0==a?!1:void $(a).each(function(a,e){DataTable.advanceTaskTable.datatable.row.add([a+1,e.createdjob,e.curaddr,e.destination,e.phone,e._id]).draw(!1)})},addRow:function(a){if(void 0==a)return!1;var e=DataTable.advanceTaskTable.datatable.rows()[0].length;DataTable.advanceTaskTable.datatable.row.add([e+1,a.createdjob,a.curaddr,a.destination,a.phone,a._id]).draw(!1)},updateRow:function(a){var e=DataTable.advanceTaskTable.$table.find('[data-ref="'+a.psg_id+'"]'),t=DataTable.advanceTaskTable.datatable.row(e).index(),n=DataTable.advanceTaskTable.datatable.cell(t,0).data();DataTable.advanceTaskTable.datatable.row(t).data([n,a.createdjob,a.curaddr,a.destination,a.phone,a.psg_id]).draw(!1)},customTableHeader:function(){$(".advance.table-data").find("#searchAdvanceTaskInput").on("keyup",function(){DataTable.advanceTaskTable.datatable.search(this.value).draw(!1)})}},pendingTaskTable:{$table:$("#pendingTaskTable"),datatable:null,initial:function(){DataTable.pendingTaskTable.datatable=DataTable.pendingTaskTable.$table.DataTable({scrollY:window.screen.availHeight-250,scrollCollapse:!0,paging:!1,searching:!0,oLanguage:{sEmptyTable:"ไม่มีข้อมูลให้แสดงผล"},columnDefs:[{targets:0,width:"30px"},{targets:1,width:"30px",className:"jobtype",render:function(a,e,t){var n='<span class="circle-text default" data-toggle="tooltip" title="คิวงานปกติ">N</span>',i='<span class="task-type circle-text orange" data-toggle="tooltip" title="งานจองล่วงหน้า">A</span>';return void 0!=a&&"QUEUE"==a?n:i}},{targets:2,width:"40px",render:function(a,e,t){return void 0==a?"":Util.getCurrentTime(a.toLocaleUpperCase())}},{targets:3,width:"50px",render:function(a,e,t){return"DPENDING_LINE"==a.status?'<span data-toggle="tooltip" title="งานนี้ต้องจ่ายผ่าน Line">'+a.drv_carplate+"</span>":"<span>"+a.drv_carplate+"</span>"},createdCell:function(a,e,t,n,i){$(a).attr("data-field-name","drv_carplate"),"DPENDING_LINE"==e.status?$(a).attr("class","line-job"):$(a).attr("class","normal-job")}},{targets:[4,5,6],className:"inline-edit",createdCell:function(a,e,t,n,i){4==i?$(a).attr("data-field-name","curaddr"):5==i?$(a).attr("data-field-name","destination"):6==i&&$(a).attr("data-field-name","phone"),$(a).attr({title:"ดับเบิ้ลคลิ๊กเพื่อแก้ไข","data-toggle":"tooltip"}).on("dblclick",DataTable.inlineEditable)}},{targets:6,width:"50px"},{targets:7,width:"50px",render:function(a,e,t){var n="";if("DEPENDING_REJECT"==a.status)n+='<span class="label-rejected"><i class="fa fa-exclamation"></i> งานถูกปฏิเสธ</span>';else{n+='<span class="status-time '+Util.getTimeStatus(a.createdjob)+'">',n+='<i class="fa fa-bookmark"></i>';var i=Util.getDiffTime(a.createdjob);n+='<span class="detail">'+i.time+"<br><span>"+i.unit+"</span>",n+="</span>"}return n}},{targets:8,width:"70px",render:function(a,e,t){var n='<div class="btn-group" role="group" aria-label="...">';return"DPENDING_LINE"==a.status?(n+='<button type="button" class="btn btn-default showAssignLineModal" data-toggle="tooltip" title="จ่ายงานผ่าน Line" onclick="DataTable.pendingTaskTable.callAssignByLineAppModal(this);">',n+='<i class="material-icons">chat</i>',n+="</button>"):n+='<button type="button" class="btn btn-default showFindTaxi" data-toggle="tooltip" title="จ่ายงาน" onclick="DataTable.pendingTaskTable.callTaxiModal(this);"><i class="fa fa-taxi"></i></button>',n+='<button type="button" class="btn btn-default removeCurrentPassenger" data-toggle="tooltip" title="ลบออก" onclick="Passenger.showConfirmRemoveModal(\''+a._id+'\');"><i class="fa fa-trash-o"></i></button>',n+="</div>"}}],createdRow:function(a,e,t){$(a).attr("data-ref",e[8]._id),$(a).addClass("pending"),$(a).find('[data-toggle="tooltip"]').tooltip({placement:"top",container:"body",animation:!1}).on("show.bs.tooltip",function(){$("body").find(".tooltip.in").remove()})},rowCallback:function(a,e,t){$(a).find(".showFindTaxi").data(e),$(a).find(".showAssignLineModal").data(e)},drawCallback:function(a){}}),DataTable.pendingTaskTable.update(!1)},update:function(a){Http.post("service/ubeam/getdpendinglist",{loader:a,onSuccess:function(a){a.status?(DataTable.pendingTaskTable.datatable.clear(),DataTable.pendingTaskTable.create(a.data),DataTable.pendingTaskTable.customTableHeader(),Socket.emit("update state")):(DataTable.pendingTaskTable.datatable.clear().draw(!1),DataTable.pendingTaskTable.setIndicator())}})},create:function(a){return void 0==a?!1:($(a).each(function(a,e){DataTable.pendingTaskTable.datatable.row.add([a+1,e.jobtype,e.createdjob,{status:e.status,drv_carplate:e.drv_carplate},e.curaddr,e.destination,e.phone,{status:e.status,createdjob:e.createdjob},{_id:e._id,status:e.status}]).draw(!1)}),void DataTable.pendingTaskTable.setIndicator())},addRow:function(a){if(void 0==a)return!1;var e=DataTable.pendingTaskTable.datatable.rows()[0].length;DataTable.pendingTaskTable.datatable.row.add([e+1,a.jobtype,a.createdjob,{status:a.status,drv_carplate:a.drv_carplate},a.curaddr,a.destination,a.phone,{status:a.status,createdjob:a.createdjob},{_id:a._id,status:a.status}]).draw(!1),DataTable.pendingTaskTable.setIndicator()},updateRow:function(a){var e=DataTable.pendingTaskTable.$table.find('[data-ref="'+a._id+'"]'),t=DataTable.pendingTaskTable.datatable.row(e).index(),n=DataTable.pendingTaskTable.datatable.cell(t,0).data();DataTable.pendingTaskTable.datatable.row(t).data([n,a.jobtype,a.createdjob,{status:a.status,drv_carplate:a.drv_carplate},a.curaddr,a.destination,a.phone,{status:a.status,createdjob:a.createdjob},{_id:a._id,status:a.status}]).draw(!1)},updateTimeStatus:function(){null!=DataTable.pendingTaskTable.datatable&&DataTable.pendingTaskTable.$table.find("tr").each(function(a,e){if($(e).is("[data-ref]")){var t=DataTable.pendingTaskTable.datatable.cell(e,7).render("type");$(e).find("td:eq(7)").html(t),DataTable.pendingTaskTable.setIndicator()}})},customTableHeader:function(){$(".pending.table-data").find("#searchPendingTaskInput").on("keyup",function(){DataTable.pendingTaskTable.datatable.search(this.value).draw(!1)})},setIndicator:function(){var a=DataTable.pendingTaskTable.datatable.row().length;a>0?$("#pendingAssignedTab").find('[aria-controls="table-pending-tab"]').find(".indicator").html(a).show():$("#pendingAssignedTab").find('[aria-controls="table-pending-tab"]').find(".indicator").hide()},callTaxiModal:function(a){var e=$(a).data();Passenger.getData(e[8]._id,function(a){if(a.status){var e=a.psg_data;Modal.assignTaskModal.modal.find(".text.phone").html(e.phone),Modal.assignTaskModal.modal.find(".text.current").html(e.curaddr),Modal.assignTaskModal.modal.find(".text.destination").html(e.destination),void 0==e.detail||""==e.detail?Modal.assignTaskModal.modal.find(".text.detail").html("<i>-</i>"):Modal.assignTaskModal.modal.find(".text.detail").html(e.detail),Modal.assignTaskModal.modal.find("#car-plate-inp").val(e.drv_carplate)[0].setSelectionRange(0,8),Modal.assignTaskModal.modal.data({passengerData:e,table:"pendingTaskTable"}),Socket.emit("assigning task",{id:e._id,table:"pendingTaskTable",user:USER_DATA}),Modal.assignTaskModal.modal.find("#pass_id").val(e._id),Modal.assignTaskModal.open()}else Notification.defaultError()})},callAssignByLineAppModal:function(a){var e=$(a).data();Passenger.getData(e[8]._id,function(a){if(a.status){var e=a.psg_data;Modal.assignTaskByLineModal.modal.find(".text.phone").html(e.phone),Modal.assignTaskByLineModal.modal.find(".text.current").html(e.curaddr),Modal.assignTaskByLineModal.modal.find(".text.destination").html(e.destination),Modal.assignTaskByLineModal.modal.find(".text.detail").html(e.detail),Modal.assignTaskByLineModal.modal.find(".text.carplate").html(e.drv_carplate),Modal.assignTaskByLineModal.modal.data({passengerData:e,table:"pendingTaskTable"}),Socket.emit("assigning task",{id:e._id,table:"pendingTaskTable",user:USER_DATA}),Modal.assignTaskByLineModal.modal.data("task",e),Modal.assignTaskByLineModal.open()}else Notification.defaultError()})}},assignedTaskTable:{$table:$("#assignedTaskTable"),datatable:null,initial:function(){DataTable.assignedTaskTable.datatable=DataTable.assignedTaskTable.$table.DataTable({paging:!0,searching:!0,scrollCollapse:!0,scrollY:window.screen.availHeight-250,oLanguage:{sEmptyTable:"ไม่มีข้อมูลให้แสดงผล",sLengthMenu:" _MENU_ "},columnDefs:[{targets:0,width:"35px"},{targets:1,width:"60px",render:function(a,e,t){return(void 0==a?"":'<span class="time">'+Util.getCurrentTime(a)+' น.</span><br/><span class="date">'+Util.getFullDate(a))+"</span>"},createdCell:function(a,e,t,n,i){$(a).attr("data-field-name","createdjob")}},{targets:2,width:"60px",render:function(a,e,t){return(void 0==a?"":'<span class="time">'+Util.getCurrentTime(a)+' น.</span><br/><span class="date">'+Util.getFullDate(a))+"</span>"},createdCell:function(a,e,t,n,i){$(a).attr("data-field-name","createdjob")}},{targets:3,createdCell:function(a,e,t,n,i){$(a).attr("data-field-name","drv_carplate")}},{targets:[4,5,6],className:"inline-edit",createdCell:function(a,e,t,n,i){4==i?$(a).attr("data-field-name","curaddr"):5==i?$(a).attr("data-field-name","destination"):6==i&&$(a).attr("data-field-name","phone"),$(a).attr({title:"ดับเบิ้ลคลิ๊กเพื่อแก้ไข","data-toggle":"tooltip"}).on("dblclick",DataTable.inlineEditable)}},{targets:7,width:"40px",render:function(a,e,t){var n='<div class="btn-group" role="group">';return n+='<button type="button" class="btn btn-link showTaskDetail" onclick="DataTable.assignedTaskTable.showTaskDetail(\''+a+"');\">แสดงรายละเอียด</button>",n+="</div>"}}],createdRow:function(a,e,t){$(a).attr("data-ref",e[7]),$(a).find('[data-toggle="tooltip"]').tooltip({placement:"top",container:"body",animation:!1}).on("show.bs.tooltip",function(){$("body").find(".tooltip.in").remove()})},rowCallback:function(a,e,t){$(a).find(".showTaskDetail").data(e)},drawCallback:function(a){var e=$(".assigned.table-data").find(".paging-length");$("#assignedTaskTable_length").detach().appendTo(e)}}),DataTable.assignedTaskTable.update(!1)},update:function(a){Http.post("service/ubeam/getassignlist",{loader:a,onSuccess:function(a){a.status?(DataTable.assignedTaskTable.datatable.clear(),DataTable.assignedTaskTable.create(a.data),DataTable.assignedTaskTable.customTableHeader(),Socket.emit("update state")):DataTable.assignedTaskTable.datatable.clear().draw()}})},updateRow:function(a){var e=DataTable.assignedTaskTable.$table.find('[data-ref="'+a._id+'"]'),t=DataTable.assignedTaskTable.datatable.row(e).index(),n=DataTable.assignedTaskTable.datatable.cell(t,0).data();DataTable.assignedTaskTable.datatable.row(t).data([n,a.createdjob,a.dpendingjob,a.drv_carplate,a.curaddr,a.destination,a.phone,a._id]).draw()},create:function(a){return void 0==a?!1:void $(a).each(function(a,e){DataTable.assignedTaskTable.datatable.row.add([a+1,e.createdjob,e.dpendingjob,e.drv_carplate,e.curaddr,e.destination,e.phone,e._id]).draw()})},addRow:function(a){if(void 0==a)return!1;var e=DataTable.assignedTaskTable.datatable.rows()[0].length;DataTable.assignedTaskTable.datatable.row.add([e+1,a.createdjob,a.dpendingjob,a.drv_carplate,a.curaddr,a.destination,a.phone,a._id]).draw()},customTableHeader:function(){$(".assigned.table-data").find("#searchAssignedTaskInput").on("keyup",function(){DataTable.assignedTaskTable.datatable.search(this.value).draw()})},showTaskDetail:function(a){Http.post("service/ubeam/getreassignjobdetail",{loader:!1,data:{psg_id:a},onSuccess:function(a){if(a.status)if(a.drv_register){var e=a.psg_data,t=a.drv_data;Modal.assignedTaskModal.modal.find(".text.phone").html(e.phone),Modal.assignedTaskModal.modal.find(".text.current").html(e.curaddr),Modal.assignedTaskModal.modal.find(".text.destination").html(e.destination),void 0==e.detail||""==e.detail?Modal.assignedTaskModal.modal.find(".text.detail").html("<i>-</i>"):Modal.assignedTaskModal.modal.find(".text.detail").html(e.detail),t.imgface=Taxi.getImageFace(t.imgface),Modal.assignedTaskModal.modal.find("img.driver-img").attr("src",t.imgface),Modal.assignedTaskModal.modal.find(".text.driver_fullname").html(t.fname+" "+t.lname),Modal.assignedTaskModal.modal.find(".text.driver_carplate").html(t.carplate),Modal.assignedTaskModal.modal.find(".text.driver_phone").html(t.phone),Modal.assignedTaskModal.modal.find(".reject-btn").prop("disabled",!1),Modal.assignedTaskModal.modal.find(".reject-btn").attr("data-ref",e._id),Modal.assignedTaskModal.addDriverToMap(t),Modal.assignedTaskModal.open()}else{var e=a.psg_data;Modal.assignedTaskModal.modal.find(".text.phone").html(e.phone),Modal.assignedTaskModal.modal.find(".text.current").html(e.curaddr),Modal.assignedTaskModal.modal.find(".text.destination").html(e.destination),void 0==e.detail||""==e.detail?Modal.assignedTaskModal.modal.find(".text.detail").html("<i>-</i>"):Modal.assignedTaskModal.modal.find(".text.detail").html(e.detail),Modal.assignedTaskModal.modal.find(".reject-btn").prop("disabled",!1),Modal.assignedTaskModal.modal.find(".reject-btn").attr("data-ref",e._id),Modal.assignedTaskModal.modal.find(".driver-wrap").hide(),Modal.assignedTaskModal.modal.find(".alert-missing-driver").html("งานนี้ถูกจ่ายไปยังแท็กซี่นอกระบบ!<br>หมายเลข: "+e.drv_carplate).show(),Modal.assignedTaskModal.open()}else Notification.defaultError()}})}},taxiReportTable:{$table:$("#taxiReportTable"),datatable:null,initial:function(){DataTable.taxiReportTable.datatable=DataTable.taxiReportTable.$table.DataTable({responsive:!0,scrollY:"400px",scrollCollapse:!0,paging:!1,language:{search:"",searchPlaceholder:"ค้นหาแท็กซี่"},footer:!1,dom:"Bfrtip",buttons:["csv","excel","pdf"]}),$("#report-date-filter").datetimepicker({format:"DD/MM/YYYY"})},update:function(a){Http.post("service/ubeam/searchdrv",{loader:a,data:{curlat:USER_CURRENT_LOCATION[0],curlng:USER_CURRENT_LOCATION[1]},onSuccess:function(a){a.status&&(DataTable.taxiReportTable.create(a.data),DataTable.taxiReportTable.customTableHeader())}})},create:function(a){return void 0==a?!1:void $(a).each(function(a,e){DataTable.taxiReportTable.addRow(a,e)})},addRow:function(a,e){var t=Math.floor(20*Math.random()+1);DataTable.taxiReportTable.datatable.row.add([a+1,e.fname+" "+e.lname,e.carplate,e.carcolor,e.phone,t,"฿ "+20*t]).draw(!1)},customTableHeader:function(){$(".report-driver.table-data").find("#searchReportDriverInput").on("keyup",function(){DataTable.taxiReportTable.datatable.search(this.value).draw(!1)})}},inlineEditable:function(a){if($(a.target).closest("tr").hasClass("lock"))return!1;var e=$(a.target).closest("tr").attr("data-ref"),t=$(a.target).closest("table").prop("id");Socket.emit("inline edit",{id:e,table:t,user:USER_DATA});var n=$(this),i=$(this).html();n.addClass("active"),n.html('<form><input type="text" value="'+i+'" /></form>'),n.find("form > input").focus(),n.unbind("dblclick",DataTable.inlineEditable);var o=function(a){if(!$(a.target).parent().parent().hasClass("inline-edit")){$(".inline-edit.active").removeClass("active"),n.on("dblclick",DataTable.inlineEditable),$(document).unbind("click",o);var e=n.closest("tr").attr("data-ref"),t=n.closest("table").prop("id");Socket.emit("unlock line",{id:e,table:t})}};$(document).on("click",o),n.find("form").on("submit",function(a){a.preventDefault();var e=this.firstElementChild.value;if(n.html(e),e!==i){var t=$(n).closest("tr").attr("data-ref"),s=$(n).attr("data-field-name"),d={};$(d).data(s,e),Passenger.editData(t,$(d).data())}n.on("dblclick",DataTable.inlineEditable),$(document).unbind("click",o),$("table .inline-edit.active").removeClass("active");var t=n.closest("tr").attr("data-ref"),l=n.closest("table").prop("id");Socket.emit("unlock line",{id:t,table:l})}),n.find("input").on("blur",function(a){if(n.html(this.value),this.value!==i){var e=$(n).closest("tr").attr("data-ref"),t=$(n).attr("data-field-name"),s={};$(s).data(t,this.value),Passenger.editData(e,$(s).data())}n.on("dblclick",DataTable.inlineEditable),$(document).unbind("click",o),$("table .inline-edit.active").removeClass("active");var e=n.closest("tr").attr("data-ref"),d=n.closest("table").prop("id");Socket.emit("unlock line",{id:e,table:d})})},updateAll:function(a){DataTable.queueTaskTable.update(!0),DataTable.advanceTaskTable.update(!0),DataTable.pendingTaskTable.update(!0),DataTable.assignedTaskTable.update(!0)},lockLine:function(a){var e='<p class="user-locker">'+a.user.name+"<br>กำลังทำงานนี้อยู่...</p>",t=DataTable[a.table].$table.find('[data-ref="'+a.id+'"]');t.addClass("lock"),t.find("td .user-locker").remove(),t.find("td").last().append(e)},unlockLine:function(a){var e=DataTable[a.table].$table.find('[data-ref="'+a.id+'"]');e.removeClass("lock"),e.find("td .user-locker").remove()}},Form={createTaskForm:{form:$("#createTaskForm"),initial:function(){Form.createTaskForm.onSubmit(),Form.createTaskForm.form.find("#pass-phone-inp").ForceNumericOnly(),Form.createTaskForm.form.find("#taxiAmount").ForceNumericOnly()},onSubmit:function(){Form.createTaskForm.form.validate({rules:{phone:{required:!0,number:!0},current:{required:!0},destination:{required:!0},taxiAmount:{required:!0}},submitHandler:function(a,e){e.preventDefault();var a=Form.createTaskForm.form,t={};t.phone=a.find("#pass-phone-inp").val(),t.curaddr=a.find("#pass-from-inp").val(),t.destination=a.find("#pass-dest-inp").val(),t.detail=a.find("#pass-desc-txt").val(),t.amount=a.find("#taxiAmount").val(),t.jobtype=a.find("#jobType").is(":checked")?"ADVANCE":"QUEUE","ADVANCE"==t.jobtype&&(t.createdjob=new Date(DateTimePicker.picker.data("DateTimePicker").date()).getTime()),Http.post("service/ubeam/addjoblist",{data:t,onSuccess:function(a){a.status?(Notification.defaultSuccess(),Form.createTaskForm.clearFormData()):Notification.defaultError(),Form.createTaskForm.form.find("#pass-phone-inp").focus(),DateTimePicker.setMinDate()}})}})},clearFormData:function(){var a=Form.createTaskForm.form;a.find("#pass-phone-inp").val(""),a.find("#pass-from-inp").val(""),a.find("#pass-dest-inp").val(""),a.find("#pass-desc-txt").val(""),a.find("#taxiAmount").val("1")}},assignTaskForm:{form:$("#assignTaskForm"),initial:function(){Form.assignTaskForm.onSubmit()},onSubmit:function(){Form.assignTaskForm.form.validate({rules:{carplate:{required:!0}},submitHandler:function(a,e){e.preventDefault();var a=Form.assignTaskForm.form,t=a.find("#pass_id").val(),n=a.find("#car-plate-inp").val();if(""!=n||void 0!=t){Form.assignTaskForm.form.find("input, button").attr("disabled",!0);var i=function(a){if(a.status)if(a.status&&"ON"==a.data.status)Passenger.sendtoRegisterDriver(this.data.psg_id,a.data._id);else if(a.status&&"WAIT"==a.data.status)Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Modal.messageBoxModal.setTitle("คำเตือน!"),Modal.messageBoxModal.setMessage("ผู้ใช้งานดังกล่าว กำลังรอตอบกลับจากผู้โดยสาร<br>ไม่สามารถจ่ายงานให้ได้"),Modal.messageBoxModal.open();else if(a.status&&"DPENDING"==a.data.status)Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Modal.messageBoxModal.setTitle("คำเตือน!"),Modal.messageBoxModal.setMessage("ผู้ใช้งานดังกล่าว กำลังรับงานอื่นจาก Callcenter<br>ไม่สามารถจ่ายงานให้ได้"),Modal.messageBoxModal.open();else if(a.status&&"BUSY"==a.data.status)Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),
Modal.messageBoxModal.setTitle("คำเตือน!"),Modal.messageBoxModal.setMessage("ผู้ใช้งานดังกล่าว กำลังไปรับผู้โดยสาร<br>ไม่สามารถจ่ายงานให้ได้"),Modal.messageBoxModal.open();else if(a.status&&"PICK"==a.data.status)Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Modal.messageBoxModal.setTitle("คำเตือน!"),Modal.messageBoxModal.setMessage("ผู้ใช้งานดังกล่าว กำลังไปส่งผู้โดยสาร<br>ไม่สามารถจ่ายงานให้ได้"),Modal.messageBoxModal.open();else if(a.status&&"OFF"==a.data.status)Passenger.sendtoRegisterDriver(this.data.psg_id,a.data._id);else if(a.status&&"BROKEN"==a.data.status)Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Modal.messageBoxModal.setTitle("คำเตือน!"),Modal.messageBoxModal.setMessage("ผู้ใช้งานดังกล่าว รถเสีย<br>ไม่สามารถจ่ายงานให้ได้"),Modal.messageBoxModal.open();else{var e=Modal.assignTaskModal.modal.find("#car-plate-inp").prop("disabled",!1)[0];e.focus(),e.setSelectionRange(0,8),Modal.assignTaskModal.modal.find("[type=submit]").prop("disabled",!1),Notification.defaultError()}else Modal.confirmNoneRegisterDriverModal.data={psg_id:this.data.psg_id,carplate:this.data.carplate},Modal.confirmNoneRegisterDriverModal.open()},o={carplate:n,psg_id:t};Taxi.checkStatus(o,i)}return!1}})},autocompleteInit:function(){var a={type:"POST",paramName:"keyword",serviceUrl:"service/ubeam/searchnamecar",transformResult:function(a,e){var a=JSON.parse(a);return a.status?{suggestions:$.map(a.data,function(a){return{value:a.carplate,data:a,ID:a._id}})}:{suggestions:{}}},onSearchStart:function(a){Form.assignTaskForm.form.find("#carNumber").removeAttr("data-driver-ref")},onSelect:function(a){Form.assignTaskForm.form.find("#carNumber").attr("data-driver-ref",a.data._id)}};Form.assignTaskForm.form.find("#carNumber").autocomplete(a)},clearFormData:function(){Modal.assignTaskModal.modal.find("p.value").text(""),Form.assignTaskForm.form.find("input[type=text]").val("")}},announceForm:{form:$("#announceForm"),initial:function(){Form.announceForm.onSubmit()},onSubmit:function(){Form.announceForm.form.validate({rules:{topic:{required:!0},detail:{required:!0}},submitHandler:function(a,e){e.preventDefault();var t={username:USER_DATA.username,topic:$(a).find('[name="topic"]').val(),detail:$(a).find('[name="detail"]').val()};Http.post("service/ubeam/announcement/add",{data:t,onSuccess:function(e){e.status?(Notification.defaultSuccess(),$(a).find('[name="topic"]').val(""),$(a).find('[name="detail"]').val(""),Modal.announcementModal.modal.find(".modal-body").empty(),Announcement.getAll()):Notification.defaultError()}})}})}},announceEditForm:{form:$("#announceEditForm"),initial:function(){Form.announceEditForm.onSubmit()},onSubmit:function(){Form.announceEditForm.form.validate({rules:{topic:{required:!0},detail:{required:!0}},submitHandler:function(a,e){e.preventDefault();var t={user_id:USER_DATA._id,ann_id:$(a).find('[name="ann_id"]').val(),topic:$(a).find('[name="topic"]').val(),detail:$(a).find('[name="detail"]').val()};Http.post("service/ubeam/announcement/edit",{data:t,onSuccess:function(e){e.status?(Notification.defaultSuccess(),$(a).find('[name="topic"]').val(""),$(a).find('[name="detail"]').val(""),Modal.announcementEditModal.close(),Announcement.getAll()):Notification.defaultError()}})}})}}},GooglePlacesSearch={input:$("#map-search-inp"),initial:function(){function a(a,e){if(Preloader.hide(),e==google.maps.places.PlacesServiceStatus.OK)for(var t=0;t<a.length;t++){var n=a[t];Taxi.findNearestPassenger(n.geometry.location)}}var e,t={},n={zoom:13,center:new google.maps.LatLng(USER_CURRENT_LOCATION[0],USER_CURRENT_LOCATION[1])};Map=new google.maps.Map(document.getElementById("map"),n);var i=document.getElementById("form_search_location");i.addEventListener("submit",function(e){e.preventDefault(),Preloader.show(),t.language="th",t.query=this.firstElementChild.value,service.textSearch(t,a)}),e=new google.maps.InfoWindow,service=new google.maps.places.PlacesService(Map)}},HotKey={initial:function(){window.addEventListener("keyup",this.doubleCtrl),window.addEventListener("keyup",this.F2)},delta:500,lastKeypressTime:0,doubleCtrl:function(a){if(17==a.keyCode||17==a.which){var e=new Date;if(e-HotKey.lastKeypressTime<=HotKey.delta){var t=Modal.assignTaskModal.modal.is(":visible");t&&Modal.assignTaskModal.toggleFullScreen(),e=0}HotKey.lastKeypressTime=e}},F2:function(a){(113==a.keyCode||113==a.which)&&($("#createTaskModal").is(":visible")||Modal.createTaskModal.open(a))}},Http={connection_error_time:0,getJson:function(a,e){void 0===e.loader||e.loader||Preloader.show(),$.getJSON(a,function(a){void 0!==e&&void 0!==e.onSuccess&&"function"==typeof e.onSuccess&&e.onSuccess(a)}).fail(function(){Notification.defaultError()}).always(function(){Preloader.hide()})},post:function(a,e){(e.loader||void 0==e.loader)&&Preloader.show(),void 0==e.data&&(e.data={}),$.post(a,e.data,function(a){void 0!==e&&void 0!==e.onSuccess&&"function"==typeof e.onSuccess&&e.onSuccess(a)}).fail(function(){Http.connection_error_time<10?Http.connection_error_time++:Http.connection_error_time>=10&&(Http.connection_error_time=0,Http.onConnectionLost())}).always(function(){Preloader.hide()})},onConnectionLost:function(){var a='<div class="connect_lost_message"><div class="message">';a+='<i class="fa fa-mixcloud"></i><br><p class="text">การเชื่อมต่อมีปัญหา</p><a href="#" onclick="location.reload();" class="btn btn-link link">โหลดหน้านี้ใหม่อีกครั้ง</a>',a+="</div></div>",$("body").find("> .connect_lost_message").remove(),$("body").append(a),$("body").find("> .connect_lost_message").fadeIn("fast")}},iOSwitchery={initial:function(){this.create(),this.eventHandler()},eventHandler:function(){$("#createTaskForm").find(".js-switch").on("change",function(a){this.checked?$(".datetime-overlay").fadeOut():$(".datetime-overlay").fadeIn()}),$(".taxi-counter").find(".js-switch").on("change",function(a){var e=$(a.target).closest(".list-group-item");e.hasClass("OFF")?Taxi.toggleStatus("OFF",this.checked):e.hasClass("ON")?Taxi.toggleStatus("ON",this.checked):e.hasClass("WAIT")?Taxi.toggleStatus("WAIT",this.checked):e.hasClass("DPENDING")?Taxi.toggleStatus("DPENDING",this.checked):e.hasClass("BUSY")?Taxi.toggleStatus("BUSY",this.checked):e.hasClass("PICK")?Taxi.toggleStatus("PICK",this.checked):e.hasClass("ASSIGNED")?Taxi.toggleStatus("ASSIGNED",this.checked):e.hasClass("BROKEN")&&Taxi.toggleStatus("BROKEN",this.checked)})},create:function(){var a=$("#createTaskForm").find(".js-switch")[0];new Switchery(a);$(".taxi-counter").find(".js-switch").each(function(a,e){new Switchery(e,{size:"small"})})}},JQuery={NumberOnlyInit:function(){jQuery.fn.ForceNumericOnly=function(){return this.each(function(){$(this).keydown(function(a){var e=a.charCode||a.keyCode||0||a.which;return 8==e||9==e||13==e||27==e||46==e||190==e||e>=35&&40>=e||e>=48&&57>=e||e>=96&&105>=e})})}}},Loader={initial:function(){Preloader.setOption({timeout:700,className:"la-ball-clip-rotate la-dark",color:"#B21616"})}},Modal={initial:function(){$(document).on("show.bs.modal",".modal",function(a){var e=1040+10*$(".modal:visible").length;$(this).css("z-index",e),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",e-1).addClass("modal-stack")},0)})},createTaskModal:{modal:$("#createTaskModal"),initial:function(){Modal.createTaskModal.modal.on("shown.bs.modal",function(a){document.getElementById("pass-phone-inp").focus()}),Modal.createTaskModal.modal.on("hidden.bs.modal",function(a){Form.createTaskForm.form.find("label.error").hide()})},open:function(a){void 0!==a&&a.stopPropagation(),Modal.createTaskModal.modal.modal("show")}},assignTaskModal:{modal:$("#assignTaskModal"),initial:function(){Modal.assignTaskModal.modal.find("#form_search_location").remove(),Modal.assignTaskModal.modal.on("show.bs.modal",function(a){var e=$(this).find(".map-wrap");jQuery("#map").detach().appendTo(e).removeClass("hide"),Taxi.clear()}),Modal.assignTaskModal.modal.on("shown.bs.modal",function(a){document.getElementById("car-plate-inp").focus(),Taxi.findInCenterMap(),Map.on("dragend",Taxi.findInCenterMap),setTimeout(function(){Map.invalidateSize()},100)}),Modal.assignTaskModal.modal.on("hidden.bs.modal",function(a){Taxi.clear(),Map.off("dragend",Taxi.findInCenterMap),Form.assignTaskForm.form.find(".text").val(""),Form.assignTaskForm.form.find("input").val(""),Form.assignTaskForm.form.find("input, button").attr("disabled",!1),Form.assignTaskForm.form.find("button[type=submit]").show(),Form.assignTaskForm.form.find("label.error").hide(),Socket.emit("unlock line",{id:$(this).data("passengerData")._id,table:$(this).data("table")}),$.removeData(this,["passengerData","table"])})},open:function(a){Modal.assignTaskModal.modal.modal("show")},close:function(a){Modal.assignTaskModal.modal.modal("hide")},toggleFullScreen:function(){Modal.assignTaskModal.modal.find(".modal-dialog").toggleClass("full-screen"),Modal.assignTaskModal.modal.find(".modal-dialog").hasClass("full-screen")?(Modal.assignTaskModal.modal.find(".map-wrap").parent().removeClass("col-md-8 col-lg-8"),Modal.assignTaskModal.modal.find(".map-wrap").parent().addClass("col-md-9 col-lg-9"),Modal.assignTaskModal.modal.find(".detail-wrap").parent().removeClass("col-md-4 col-lg-4"),Modal.assignTaskModal.modal.find(".detail-wrap").parent().addClass("col-md-3 col-lg-3")):(Modal.assignTaskModal.modal.find(".map-wrap").parent().removeClass("col-md-9 col-lg-9"),Modal.assignTaskModal.modal.find(".map-wrap").parent().addClass("col-md-8 col-lg-8"),Modal.assignTaskModal.modal.find(".detail-wrap").parent().removeClass("col-md-3 col-lg-3"),Modal.assignTaskModal.modal.find(".detail-wrap").parent().addClass("col-md-4 col-lg-4")),setTimeout(function(){Map.invalidateSize()},100)}},assignTaskByLineModal:{modal:$("#assignTaskByLineModal"),initial:function(){Modal.assignTaskByLineModal.modal.on("show.bs.modal",function(a){$(this).find("button[type=submit]").on("click",Modal.assignTaskByLineModal.onSubmit)}),Modal.assignTaskByLineModal.modal.on("hidden.bs.modal",function(a){$.removeData(this,"task"),$(this).find("p.text").html(""),$(this).find("button[type=submit]").unbind("click"),$(this).find(".modal-footer").show(),Socket.emit("unlock line",{id:$(this).data("passengerData")._id,table:$(this).data("table")}),$.removeData(this,["passengerData","table"])})},open:function(a){Modal.assignTaskByLineModal.modal.modal("show")},onSubmit:function(){var a=Modal.assignTaskByLineModal.modal.data("task");Taxi.assignByLineApp(a._id,a.drv_carplate)}},assignedTaskModal:{modal:$("#assignedTaskModal"),layer:L.layerGroup(),initial:function(){Map&&Map.addLayer(this.layer),Modal.assignedTaskModal.modal.on("shown.bs.modal",function(a){var e=$(this).find(".map-wrap");jQuery("#map").detach().appendTo(e).removeClass("hide"),$(this).find(".reject-btn").on("click",function(a){$(this).attr("disabled",!0);var e=$(this).attr("data-ref");Passenger.showConfirmRejectModal(e)}),setTimeout(function(){Map.invalidateSize()},10)}),Modal.assignedTaskModal.modal.on("hidden.bs.modal",function(a){Map.control.search.enable(),$(this).find(".text").html(""),$(this).find("img.driver-img").attr("src",""),$(this).find(".ribbon-message").remove(),$(this).find(".reject-btn").show(),$(this).find(".reject-btn").prop("disabled",!1).attr("data-ref",""),$(this).find(".reject-btn").unbind("click",Passenger.showConfirmRejectModal),$(this).find(".driver-wrap").show(),$(this).find(".alert-missing-driver").hide(),Modal.assignedTaskModal.clearMarker()})},open:function(){Modal.assignedTaskModal.modal.modal("show")},addDriverToMap:function(a){Modal.assignedTaskModal.clearMarker();var e=L.marker([a.curloc[1],a.curloc[0]],{icon:L.icon({iconUrl:"/assets/img/map/tx_PICK@2x.png",iconAnchor:[20,20],labelAnchor:[10,0]})});Modal.assignedTaskModal.layer.addLayer(e),Map.setCenter(e.getLatLng())},clearMarker:function(){Modal.assignedTaskModal.layer.clearLayers()}},confirmModal:{modal:$("#confirmModal"),initial:function(){},open:function(){Modal.confirmModal.modal.modal("show")}},confirmNoneRegisterDriverModal:{data:{},modal:$("#confirmNoneRegisterDriverModal"),initial:function(){Modal.confirmNoneRegisterDriverModal.modal.on("shown.bs.modal",function(){$(this).find(".btn.confirm").focus()}),Modal.confirmNoneRegisterDriverModal.modal.on("hidden.bs.modal",function(){Modal.confirmNoneRegisterDriverModal.data={},Form.assignTaskForm.form.find("input, button").prop("disabled",!1),Form.assignTaskForm.form.find("input").focus()}),Modal.confirmNoneRegisterDriverModal.modal.find(".confirm").on("click",function(){if(!$.isEmptyObject(Modal.confirmNoneRegisterDriverModal.data)){var a=Modal.confirmNoneRegisterDriverModal.data;Passenger.sendToNoneRegisterDriver(a.psg_id,a.carplate)}})},open:function(){Modal.confirmNoneRegisterDriverModal.modal.modal("show")},close:function(){Modal.confirmNoneRegisterDriverModal.modal.modal("hide")}},successModal:{modal:$("#successModal"),initial:function(){Modal.successModal.modal.on("shown.bs.modal",function(a){$(this).find('[data-dismiss="modal"]').focus()}),Modal.successModal.modal.on("hidden.bs.modal",function(a){$(this).find(".message").empty()})},open:function(){Modal.successModal.modal.modal("show")},close:function(){Modal.successModal.modal.modal("hide")},setMessage:function(a){Modal.successModal.modal.find(".message").html(a)}},announcementModal:{modal:$("#announcementModal"),initial:function(){Modal.announcementModal.modal.on("show.bs.modal",function(a){Announcement.getAll()}),Modal.announcementModal.modal.on("shown.bs.modal",function(a){}),Modal.announcementModal.modal.on("hidden.bs.modal",function(a){$(this).find(".modal-body").empty(),Form.announceForm.form.find("label.error").remove()})},open:function(){Modal.announcementModal.modal.modal("show")},close:function(){Modal.announcementModal.modal.modal("hide")}},announcementEditModal:{modal:$("#announcementEditModal"),initial:function(){Modal.announcementEditModal.modal.on("hidden.bs.modal",function(a){$(this).find(".modal-body").find("input[type='text'], input[type='hidden'], textarea").val(""),Form.announceEditForm.form.find("label.error").remove()})},open:function(){Modal.announcementEditModal.modal.modal("show")},close:function(){Modal.announcementEditModal.modal.modal("hide")}},reportModal:{modal:$("#reportModal"),initial:function(){Modal.reportModal.modal.on("hidden.bs.modal",function(a){DataTable.taxiReportTable.datatable.clear().draw(!1)}),Modal.reportModal.modal.on("show.bs.modal",function(a){DataTable.taxiReportTable.update()}),Modal.reportModal.modal.on("shown.bs.modal",function(a){})}},messageBoxModal:{modal:$("#messageBoxModal"),initial:function(){Modal.messageBoxModal.modal.on("hidden.bs.modal",function(a){Modal.messageBoxModal.clearData()})},open:function(){Modal.messageBoxModal.modal.modal("show")},close:function(){Modal.messageBoxModal.modal.modal("hide")},setTitle:function(a){Modal.messageBoxModal.modal.find(".modal-body").find(".title").html(a)},setMessage:function(a){Modal.messageBoxModal.modal.find(".modal-body").find(".message").html(a)},clearData:function(){Modal.messageBoxModal.modal.find(".modal-body").find(".title").empty(),Modal.messageBoxModal.modal.find(".modal-body").find(".message").empty()}}},Monitoring={taxi:null,status:{OFF:0,ON:0,WAIT:0,DPENDING:0,BUSY:0,PICK:0,ASSIGNED:0,BROKEN:0},initial:function(){this.updateNotification(),this.intervalUpdateNotification(),$(".navbar .navbar-right > .monitoring-tab").find('[data-toggle="tooltip"]').tooltip({placement:"bottom",container:"body",animation:!1}),$(".taxi-counter").find('[data-toggle="tooltip"]').tooltip({placement:"left",container:"body",animation:!1}).on("show.bs.tooltip",function(){$("body").find(".tooltip.in").remove()})},isActive:!1,toggle:function(a){this.isActive?this.hide(a):this.show(a)},show:function(a){if(a.preventDefault(),this.isActive)return!1;Preloader.show(),$(".navbar .navbar-right > .monitoring-tab").find(".counter-wrapper").hide(),$(".navbar .navbar-right > .monitoring-tab").addClass("active"),$(".navbar .navbar-right > .callcenter-tab").removeClass("active");var e=$(".container-fluid.monitoring"),t=($("#map").is(":visible"),$("#map").parent().is(".monitoring"));t||jQuery("#map").detach().appendTo(e),e.show(),$("#map").removeClass("hide"),$(".container-fluid.app").hide(),Map.control.locate.enable(),App.setDefaultPosition(),setTimeout(function(){Map.invalidateSize()},10),Http.post("service/ubeam/searchdrv",{data:{curlat:USER_CURRENT_LOCATION[0],curlng:USER_CURRENT_LOCATION[1]},onSuccess:function(a){a.status?(Monitoring.taxi=[],Monitoring.clearCounter(),$(a.data).each(function(a,e){switch(e.status){case"OFF":Monitoring.status.OFF++;break;case"ON":Monitoring.status.ON++;break;case"WAIT":Monitoring.status.WAIT++;break;case"BUSY":Monitoring.status.BUSY++;break;case"PICK":Monitoring.status.PICK++;break;case"BROKEN":Monitoring.status.BROKEN++}Monitoring.taxi.push({_id:e._id,license_plate:e.carplate,lat:e.curloc[1],lng:e.curloc[0],status:e.status,imgface:e.imgface,full_name:e.fname+" "+e.lname,tel:e.phone,brokendetail:e.brokendetail,brokenname:e.brokenname})}),Monitoring.taxi.filter(function(a){return $(".taxi-counter").find(".list-group-item."+a.status).find(".js-switch").is(":checked")?void Taxi.addToMap(a,{monitoring:!0},!1):!1}),Monitoring.adjustCounter()):Taxi.clear(),Preloader.hide()}}),LandMark.getAll(),this.isActive=!0},hide:function(a){return this.isActive?($(".navbar .navbar-right > .monitoring-tab").find(".counter-wrapper").show(),$(".navbar .navbar-right > .monitoring-tab").removeClass("active"),$(".navbar .navbar-right > .callcenter-tab").addClass("active"),$(".container-fluid.monitoring").hide(),$(".container-fluid.app").show(),Map.control.locate.disable(),this.isActive=!1,Monitoring.taxi=null,void Taxi.clear()):!1},clearCounter:function(){this.status.OFF=0,this.status.ON=0,this.status.WAIT=0,this.status.DPENDING=0,this.status.BUSY=0,this.status.PICK=0,this.status.ASSIGNED=0,this.status.BROKEN=0},updateNotification:function(){Http.post("service/ubeam/countTaxi",{loader:!1,data:{curlat:USER_CURRENT_LOCATION[0],curlng:USER_CURRENT_LOCATION[1]},onSuccess:function(a){a.status&&(Monitoring.clearCounter(),$(a.data).each(function(a,e){switch(e.status){case"OFF":Monitoring.status.OFF++;break;case"ON":Monitoring.status.ON++;break;case"WAIT":Monitoring.status.WAIT++;break;case"DPENDING":Monitoring.status.DPENDING++;break;case"BUSY":Monitoring.status.BUSY++;break;case"PICK":Monitoring.status.PICK++;break;case"ASSIGNED":Monitoring.status.ASSIGNED++;break;case"BROKEN":Monitoring.status.BROKEN++}}),Monitoring.adjustCounter())}})},adjustCounter:function(){var a=$(".monitoring").find(".taxi-counter");a.find(".OFF .badge").text(this.status.OFF),a.find(".ON .badge").text(this.status.ON),a.find(".WAIT .badge").text(this.status.WAIT),a.find(".DPENDING .badge").text(this.status.DPENDING),a.find(".BUSY .badge").text(this.status.BUSY),a.find(".PICK .badge").text(this.status.PICK),a.find(".ASSIGNED .badge").text(this.status.ASSIGNED),a.find(".BROKEN .badge").text(this.status.BROKEN);var e=$(".navbar .navbar-right > .monitoring-tab").find(".counter-wrapper");e.find(".off").text(this.status.OFF),e.find(".on").text(this.status.ON),e.find(".pick").text(this.status.PICK),e.find(".broken").text(this.status.BROKEN)},intervalUpdateNotification:function(){this.intervalId=App.intervalManager(!0,this.updateNotification,5e3)}},Notification={show:function(a){options={title:a.title,text:a.text,sticky:a.sticky?a.sticky:!1,time:"",class_name:"gritter-"+(a.$class?a.$class:"warning"),position:a.position?a.position:"bottom-center"},$.gritter.add(options)},defaultSuccess:function(a,e){$.gritter.add({title:a?a:"Success!",text:e?e:"คำสั่ง ทำงานเรียบร้อย",sticky:!1,time:1500,class_name:"gritter-success",position:"bottom-right"})},defaultError:function(a,e){$.gritter.add({title:a?a:"Server Error!",text:e?e:"Pls. refresh page and then try it again.",sticky:!1,time:2500,class_name:"gritter-danger",position:"bottom-right"})},removeAll:function(){$.gritter.removeAll({time:0,before_close:function(a){},after_close:function(){}})},remove:function(){$("#gritter-notice-wrapper").remove()}},Passenger={marker:{},getData:function(a,e){Http.post("service/ubeam/getPassengerDetail",{loader:!1,data:{psg_id:a},onSuccess:e})},editData:function(a,e){var e=jQuery.extend({psg_id:a},e);Http.post("service/ubeam/editjoblist",{loader:!1,data:e,onSuccess:function(a){a.status?(Notification.remove(),Notification.defaultSuccess()):(Notification.remove(),Notification.defaultError())}})},addToMap:function(a,e){this.removeMarker(),this.marker=L.marker(a,{icon:L.icon({iconUrl:"/assets/img/map/psg_pin.png",iconAnchor:[12,20],labelAnchor:[10,0]})});var t='<div class="row">';t+='<div class="passenger-info">',t+='<div class="col-md-12">',t+='<p class="caption">เบอร์โทรติดต่อ</p>',t+='<p class="tel value">'+e.phone+"</p>",t+="</div>",t+='<div class="col-md-12">',t+='<p class="caption">จาก</p>',t+='<p class="license_plate value">'+e.curaddr+"</p>",t+="</div>",t+='<div class="col-md-12">',t+='<p class="caption">ไปยัง</p>',t+='<p class="status value">'+e.destination+"</p>",t+="</div>",t+='<div class="col-md-12">',t+='<p class="caption">รายละเอียด</p>',t+='<p class="detail value">'+e.detail+"</p>",t+="</div>",t+="</div>",t+="</div>",this.marker.bindPopup(t,{offset:L.point(0,-18),className:"passenger-popup"}),this.marker.options.passenger_info=e,this.marker.addTo(Map)},showConfirmRejectModal:function(a){Modal.confirmModal.modal.on("shown.bs.modal",function(e){$(this).find(".confirm").on("click",function(){window.Passenger.rejectTask(a)}),setTimeout(function(){$(".modal-backdrop.in.modal-stack").css("opacity",.5)},0)}),Modal.confirmModal.modal.on("hidden.bs.modal",function(a){$(this).find(".confirm").unbind("click"),$(this).unbind("shown.bs.modal"),$(this).unbind("hidden.bs.modal"),Modal.confirmModal.modal.off("show.bs.modal"),$(".modal-backdrop.in.modal-stack").css("opacity",.1),Modal.assignedTaskModal.modal.find(".reject-btn").prop("disabled",!1)}),Modal.confirmModal.modal.find(".modal-body > .message").html("ต้องยกเลิกรายการนี้ใช่มั้ย?"),Modal.confirmModal.open()},showConfirmRemoveModal:function(a){Modal.confirmModal.modal.on("shown.bs.modal",function(e){$(this).find('[data-dismiss="modal"]').focus(),$(this).find(".confirm").on("click",function(){window.Passenger.cancelTask(a)})}),Modal.confirmModal.modal.on("hidden.bs.modal",function(a){$(this).find(".confirm").unbind("click"),$(this).unbind("shown.bs.modal"),$(this).unbind("hidden.bs.modal")}),Modal.confirmModal.modal.find(".modal-body > .message").html("ต้องการลบรายการนี้ใช่มั้ย?"),Modal.confirmModal.open()},sendtoRegisterDriver:function(a,e){Http.post("service/ubeam/assigndrvtopsg",{data:{psg_id:a,drv_id:e},onSuccess:function(a){if(a.status){Notification.defaultSuccess();var e=a.drv_data,t=[];t.push({_id:e._id,license_plate:e.carplate,lat:e.curloc[1],lng:e.curloc[0],status:"ON",imgface:e.imgface,full_name:e.fname+" "+e.lname}),Taxi.addToMap(t,{active:!1}),Form.assignTaskForm.form.find("button[type=submit]").hide(),Form.assignTaskForm.form.find("input[type=text]").prop("disabled",!0),Passenger.onAssignTaskSuccess()}else Notification.defaultError()}})},sendToNoneRegisterDriver:function(a,e){Http.post("service/ubeam/assigndrvtopsg",{data:{psg_id:a,drv_carplate:e},onSuccess:function(a){a.status?(Taxi.clear(),Notification.defaultSuccess(),Modal.confirmNoneRegisterDriverModal.close(),Form.assignTaskForm.form.find("button[type=submit]").hide(),Form.assignTaskForm.form.find("input[type=text]").prop("disabled",!0),Passenger.onAssignTaskSuccess()):Notification.defaultError()}})},cancelTask:function(a){Http.post("service/ubeam/deletejob",{data:{psg_id:a},onSuccess:function(a){a.status?(Modal.confirmModal.modal.modal("hide"),Notification.defaultSuccess()):Notification.defaultError()}})},rejectTask:function(a){Http.post("service/ubeam/cancelpsgdrv",{data:{psg_id:a},onSuccess:function(a){a.status?(Modal.confirmModal.modal.modal("hide"),Notification.defaultSuccess(),Modal.assignedTaskModal.modal.find(".reject-btn").hide().attr("data-ref",""),Modal.assignedTaskModal.modal.find(".modal-body > .content").prepend('<div class="ribbon-message error"><p class="message">งานนี้ถูกยกเลิกเรียบร้อย</p></div>'),Modal.assignedTaskModal.modal.find(".ribbon-message").fadeIn("fast")):(Notification.defaultError(),Modal.assignedTaskModal.modal.find(".reject-btn").prop("disabled",!0).attr("data-ref",""))}})},removeMarker:function(){Map.removeLayer(this.marker),this.marker={}},onAssignTaskSuccess:function(){Map.off("dragend",Taxi.findInCenterMap),Modal.successModal.setMessage("จ่ายงานเรียบร้อยแล้ว"),Modal.successModal.open()}},Socket={initial:function(){return Socket=io(),Socket.on("addjoblist",function(a){"QUEUE"==a.jobtype?DataTable.queueTaskTable.addRow(a):"ADVANCE"==a.jobtype&&DataTable.advanceTaskTable.addRow(a),Sound.play("sounds-incoming-call")}),Socket.on("deletejob",function(a){if($.inArray(a.status,["DPENDING","DEPENDING_REJECT","DPENDING_LINE"])>-1){var e=DataTable.pendingTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.pendingTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.setIndicator()}else if("QUEUE"==a.jobtype){var e=DataTable.queueTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.queueTaskTable.datatable.row(e).remove().draw(!1),DataTable.queueTaskTable.setIndicator()}else if("ADVANCE"==a.jobtype){var e=DataTable.advanceTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.advanceTaskTable.datatable.row(e).remove().draw(!1)}}),Socket.on("inline edit",function(a){DataTable.lockLine(a)}),Socket.on("unlock line",function(a){DataTable.unlockLine(a)}),Socket.on("editjoblist",function(a){$.inArray(a.status,["DPENDING","DEPENDING_REJECT","DPENDING_LINE"])>-1?Passenger.getData(a.psg_id,function(a){a.status&&(DataTable.pendingTaskTable.updateRow(a.psg_data),DataTable.pendingTaskTable.setIndicator())}):"ASSIGNED"==a.status?Passenger.getData(a.psg_id,function(a){a.status&&DataTable.assignedTaskTable.updateRow(a.psg_data)}):"QUEUE"==a.jobtype?DataTable.queueTaskTable.updateRow(a):"ADVANCE"==a.jobtype&&DataTable.advanceTaskTable.updateRow(a)}),Socket.on("assigning task",function(a){DataTable.lockLine(a)}),Socket.on("assigndrvtopsg",function(a){if($.inArray(a.status,["DPENDING","DEPENDING_REJECT","DPENDING_LINE"])>-1){var e=DataTable.queueTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.queueTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.addRow(a),DataTable.pendingTaskTable.setIndicator()}else if("ASSIGNED"==a.status){if("+"==a.drv_carplate.slice(-1)){var e=DataTable.pendingTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.pendingTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.setIndicator()}else if("+"!=a.drv_carplate.slice(-1)){var e=DataTable.queueTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.queueTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.setIndicator();var e=DataTable.pendingTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.pendingTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.setIndicator()}DataTable.assignedTaskTable.addRow(a)}}),Socket.on("cancelpsgdrv",function(a){var e=DataTable.assignedTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.assignedTaskTable.datatable.row(e).remove().draw(),DataTable.queueTaskTable.addRow(a),DataTable.queueTaskTable.setIndicator()}),Socket.on("gotdispatchaction",function(a){if("ASSIGNED"==a.psg_data.status){var e=DataTable.pendingTaskTable.$table.find('[data-ref="'+a.psg_data._id+'"]');DataTable.pendingTaskTable.datatable.row(e).remove().draw(!1),DataTable.pendingTaskTable.setIndicator(),DataTable.assignedTaskTable.addRow(a.psg_data)}else"DEPENDING_REJECT"==a.psg_data.status&&(DataTable.pendingTaskTable.updateRow(a.psg_data),DataTable.pendingTaskTable.setIndicator())}),Socket.on("driverCancelCallCenter",function(a){Passenger.getData(a.psg_id,function(a){a.status&&(DataTable.pendingTaskTable.updateRow(a.psg_data),DataTable.pendingTaskTable.setIndicator())})}),Socket.on("driverEndTask",function(a){var e=DataTable.assignedTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.assignedTaskTable.datatable.row(e).remove().draw()}),Socket.on("closeCallcenterJob",function(a){var e=DataTable.assignedTaskTable.$table.find('[data-ref="'+a._id+'"]');DataTable.assignedTaskTable.datatable.row(e).remove().draw()}),Socket.on("update state",function(a){a.filter(function(a){DataTable.lockLine(a.data)})}),Socket}},Sound={initial:function(){var a=$(".sound-notification-tab").find(".js-switch")[0];new Switchery(a,{size:"small"})},control:$(".sound-notification-tab").find(".js-switch"),play:function(a){var e=document.getElementById("sounds-incoming-call");this.control.is(":checked")&&e.play()}},Taxi={initial:function(){Map&&Map.addLayer(this.layer)},line:{},active:{},circle:L.circle(),layer:L.layerGroup(),addToMap:function(a,e,t){(void 0==t||t)&&Taxi.clear(),$(a).each(function(a,t){if(void 0!=t.lat&&void 0!=t.lng){var n=L.divIcon({className:"carplate-pin "+t.status.toLocaleLowerCase(),html:'<div class="message"><img src="/assets/img/map/tx_'+t.status.toLocaleUpperCase()+'.png">'+t.license_plate+'<div class="arrow"></div></div>',iconAnchor:[35,55]}),i=L.marker([t.lat,t.lng],{riseOnHover:!0,icon:n});t.imgface=Taxi.getImageFace(t.imgface);var o='<div class="row">';if(o+='<div class="col-md-6">',o+='<img class="driver-img" src="'+t.imgface+'" />',void 0==e&&"ON"==t.status.toLocaleUpperCase()&&(o+='<button class="btn choose" onclick="Taxi.goToPassenger();">เลือกคนนี้</button>'),o+="</div>",o+='<div class="driver-info col-md-6">',o+='<p class="full_name value">'+t.full_name+"</p>",o+='<p class="caption">เบอร์โทรติดต่อ</p>',o+='<p class="tel value">'+t.tel+"</p>",o+='<div class="pull-left">',o+='<p class="caption">ทะเบียน</p>',o+='<p class="license_plate value">'+t.license_plate+"</p>",o+="</div>",o+='<div class="pull-left">',o+='<p class="caption">สถานะ</p>',o+='<p class="status value">'+t.status+"</p>",o+="</div>",o+="</div>",o+="</div>","BROKEN"==t.status.toLocaleUpperCase()){var s='<div class="label-message-status"><h3 class="title">รถเสีย</h3><a class="call-message" href="#" onclick="Taxi.toggleBrokenDetail(this);">';s+='<span class="txt-show">แสดง</span><span class="txt-hide">ซ่อน</span>รายละเอียด',s+="</a>","[object Array]"===Object.prototype.toString.call(t.brokenname)&&(s+='<p class="list"><i>อาการ</i><br>'+t.brokenname.toString()+"</p>"),s+='<p class="detail"><i>รายละเอียด</i><br>'+t.brokendetail+"</p>",s+="</div>",o+=s}i.bindPopup(o,{offset:L.point(0,-18),className:"driver-popup"}).on("popupopen",function(a){Taxi.active=i}).on("popupclose",function(){Taxi.active={}}),i.options.taxi_info=t,Taxi.layer.addLayer(i)}})},getImageFace:function(a){return a=void 0==a||""==a?"assets/img/thumbnail_photo.jpg":"/image/driver/"+a},filter:function(a){var e=LOCAL_DATA.taxi;"all"!==a&&void 0!==LOCAL_DATA.taxi&&(e=LOCAL_DATA.taxi.filter(function(e){return e.status.toLocaleLowerCase()==a.toLocaleLowerCase()})),this.addToMap(e)},onFilterClick:function(a,e){var t=$(a).hasClass("active");$(".filter-marker.active").removeClass("active"),!t&&$(a).addClass("active");var n=$(a).attr("data-status"),i=$(".filter-marker.active").size();0==i&&(n="all"),this.filter(n)},findNearestPassenger:function(a,e){if(a.length>0){Notification.removeAll(),this.circle.setLatLng(a).setRadius(5e3),Map.fitBounds(this.circle.getBounds()),Passenger.addToMap(a,e);var t={curlat:e.curloc[0],curlng:e.curloc[1],status:"ON",radian:5e3},n=function(){Http.post("service/ubeam/searchdrv",{loader:!1,data:t,onSuccess:function(a){if(a.status){var e=[];$(a.data).each(function(a,t){e.push({_id:t._id,license_plate:t.carplate,lat:t.curlat,lng:t.curlng,status:"ON",imgface:t.imgface,full_name:t.fname+" "+t.lname,tel:t.phone,rating:"5"})}),Taxi.addToMap(e)}else Taxi.clear()}})};n()}else Notification.removeAll(),this.layer.clearLayers(),
Passenger.removeMarker(),App.setDefaultPosition(),setTimeout(function(){Notification.show({sticky:!1,$class:"primary",title:"ไม่ทราบตำแหน่งที่แน่นอนของผู้โดยสาร",text:"",position:"bottom-center"})},700)},findInCenterMap:function(){var a=Map.getCenter();Http.post("service/ubeam/searchdrv",{loader:!1,data:{status:"ON",curlat:a.lat,curlng:a.lng},onSuccess:function(a){if(a.status){var e=[];$(a.data).each(function(a,t){e.push({_id:t._id,license_plate:t.carplate,lat:t.curlat,lng:t.curlng,status:"ON",imgface:t.imgface,full_name:t.fname+" "+t.lname,tel:t.phone,rating:"5"})}),Taxi.addToMap(e)}else Taxi.clear()}})},goToPassenger:function(){var a=Taxi.active.options.taxi_info,e=Modal.assignTaskModal.modal.find("#pass_id").val(),t={psg_id:e,drv_id:a._id};Http.post("service/ubeam/assigndrvtopsg",{data:t,onSuccess:function(a){a.status?(Preloader.show(),setTimeout(function(){var e=Taxi.active.getPopup().getContent();e=e.replace("choose","choose hide"),Taxi.active.setPopupContent(e),$(e).find(".btn.choose").hide(),Taxi.layer.eachLayer(function(a){a._leaflet_id==Taxi.active._leaflet_id||a instanceof L.Polyline||Taxi.layer.removeLayer(a)}),Modal.assignTaskModal.modal.focus(),Map.off("dragend",Taxi.findInCenterMap),Form.assignTaskForm.form.find("input[type=hidden]").val(""),Form.assignTaskForm.form.find("#car-plate-inp").prop("disabled",!0),Form.assignTaskForm.form.find("button[type=submit]").hide(),Form.assignTaskForm.form.find("#car-plate-inp").val(a.drv_data.carplate),Preloader.hide(),Notification.defaultSuccess(),Passenger.onAssignTaskSuccess()},700)):Notification.defaultError()}})},assignByLineApp:function(a,e){var t={psg_id:a,drv_carplate:e,lineconfirm:"Y"};Http.post("service/ubeam/assigndrvtopsg",{data:t,onSuccess:function(a){a.status?(Preloader.show(),setTimeout(function(){Preloader.hide(),Notification.defaultSuccess(),Passenger.onAssignTaskSuccess(),Modal.assignTaskByLineModal.modal.find(".modal-footer").hide()},700)):Notification.defaultError()}})},checkStatus:function(a,e){Http.post("service/ubeam/checkdrvstatus",{loader:!1,data:a,onSuccess:e})},cancelFind:function(){Map.removeLayer(this.circle)},clear:function(){this.layer.clearLayers()},toggleStatus:function(a,e){if(e){var t=Monitoring.taxi.filter(function(e){return e.status==a});t.length>0&&Taxi.addToMap(t,{monitoring:!0},!1)}else Taxi.layer.eachLayer(function(e){e.options.taxi_info.status==a&&Taxi.layer.removeLayer(e)})},ghostTaxi:function(a){var e=[],t=this.circle.getBounds();(void 0===a||0==a)&&(a=1);for(var n=1;a>=n;n++){var i=Taxi.getRandomLatLng(t);e.push({_id:(new Date).getTime(),license_plate:"1กล 2254",lat:i.lat,lng:i.lng,status:"ON",image_driver:"",full_name:"กนกกร",tel:"082-456-8899",rating:"5"})}return e},getRandomLatLng:function(a){return southWest=a.getSouthWest(),northEast=a.getNorthEast(),lngSpan=northEast.lng-southWest.lng,latSpan=northEast.lat-southWest.lat,new L.LatLng(southWest.lat+latSpan*Math.random(),southWest.lng+lngSpan*Math.random())},toggleBrokenDetail:function(a){$(a).closest(".label-message-status").toggleClass("open")}},LandMark={initial:function(){Map&&Map.addLayer(this.layer)},getAll:function(){Http.post("service/ubeam/getPOIandParking",{onSuccess:function(a){"1"==a.status&&LandMark.addToMap(a.data)}})},layer:L.layerGroup(),clear:function(){this.layer.clearLayers()},addToMap:function(a){LandMark.clear(),$(a).each(function(a,e){var t="",n="";1==e.poitype?(n="landmark",t='<i class="material-icons">star</i>'):e.poitype&&(n="parking",t='<i class="material-icons">local_parking</i>');var i=L.divIcon({className:"position-pin "+n,html:'<div class="wrapper"><div class="icon">'+t+'</div><div class="text">'+e.name+'</div><div class="arrow"></div></div>',iconAnchor:[35,55]}),o=L.marker([e.curloc[1],e.curloc[0]],{riseOnHover:!0,icon:i});o.options.landMarkerInfo=e,LandMark.layer.addLayer(o)})}},Util={getCurrentTime:function(a){var e=function(a){return 10>a&&(a="0"+a),a},t=void 0==a?new Date:new Date(a),n=e(t.getHours()),i=e(t.getMinutes());e(t.getSeconds());return n+":"+i},getFullDate:function(a){var e=new Date(a),t=e.getDate(),n=e.getMonth()+1,i=e.getFullYear();return t+"/"+n+"/"+i},diffTime:function(a,e){return(e-a)/1e3/60},executeFunctionByName:function(a,e){for(var t=[].slice.call(arguments).splice(2),n=a.split("."),i=n.pop(),o=0;o<n.length;o++)e=e[n[o]];return e[i].apply(e,t)},getTimeStatus:function(a){var e=Util.diffTime(new Date(a).getTime(),(new Date).getTime()),t="new";return-1>e?t="book":e>0&&1>=e?t="new":e>1&&5>=e?t="normal":e>5&&(t="long"),t},getDiffTime:function(a){var e=Util.diffTime(new Date(a).getTime(),(new Date).getTime()),t={};if(60>e){var n=Math.floor(e);t.time=0==n||0>n?"นาที":n+" น.",t.unit="ที่แล้ว"}else e>=60&&1440>=e?(t.time=Math.floor((Math.abs(new Date(a).getTime()-(new Date).getTime())/36e5).toFixed(2))+" ชม.",t.unit="ที่แล้ว"):e>1440&&(t.time="นานมาก",t.unit="แล้ว");return t}};!function(){App.init(),setInterval(function(){DataTable.queueTaskTable.updateTimeStatus(),DataTable.pendingTaskTable.updateTimeStatus()},5e3)}();